{
  "hash": "2469ddd6b6bd825391f18f26d22547a6",
  "result": {
    "markdown": "---\ntitle: \"Conques hidrogràfiques de Catalunya\"\nauthor: \"Marc Bosch\"\ndate: \"2023-02-08\"\ncategories: [R, openstreetmap, tmap]\nexecute:\n  warning: false\n  error: false\n  message: false\nformat:\n  html: \n    code-fold: true\n    code-summary: \"Show the code\"\n    fig-width: 15\nimage: rius_estatic.png\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tmap)\nlibrary(sf)\nlibrary(igraph)\ntmap::tmap_mode(\"plot\")\n```\n:::\n\n\nFa no massa vaig veure un mapa d'Europa amb totes les seves conques fluvials. Avui intentarem fer el mateix amb R utilitzant dades d'OpenStreetMap. Primer, llegim les dades de rius, rieres i torrents.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrius <- st_read(\"/home/marc/Documents/30dayMapChallenge/data/cataluna-latest.osm.pbf\",\n                query = \"select * from lines where waterway in ('river','stream')\")\nbm <- tmaptools::read_osm(rius)\n```\n:::\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\ntm_shape(bm) + \n  tm_rgb(alpha = 0.2) + \n  tm_shape(rius) + \n  tm_lines(col = \"blue\") + \n  tm_layout(frame = F)\n```\n\n::: {.cell-output-display}\n![Rius, rieres i rierols de Catalunya. Una mica caòtic, no?\\nFont Col·laboradors d'OpenStreetMap](20230208_files/figure-html/unnamed-chunk-3-1.png){width=960}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(select(rius, name, waterway, `_ogr_geometry_`)), style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|name               |waterway |_ogr_geometry_                 |\n|:------------------|:--------|:------------------------------|\n|Riu Besòs          |river    |LINESTRING (2.251363 41.546... |\n|Riu de Comallempla |stream   |LINESTRING (1.444706 42.569... |\n|Riu de Setúria     |river    |LINESTRING (1.440852 42.545... |\n|Riera dels Canyars |stream   |LINESTRING (1.971461 41.297... |\n|NA                 |stream   |LINESTRING (2.01132 41.2843... |\n|NA                 |stream   |LINESTRING (2.007163 41.280... |\n:::\n:::\n\n\nPer a crear un mapa de conques hidrogràfiques, cal que ajuntem tots els rius que es toquen entre sí. Tocarà jugar una mica amb xarxes. També ho haurem de filtrar per tenir només les que fan més de 100 km de llargada, perquè el mapa sigui llegible.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_idx_touches <- st_touches(rius) # determinar quins segments es toquen entre sí\nxarxa_rius <- graph_from_adj_list(my_idx_touches) # crear una xarxa\nids <- components(xarxa_rius)$membership # crear un vector amb el grup al qual pertany cada segment de riu\nrius_agrupat <- rius |> \n  group_by(conca = as.character({{ids}})) |>  \n  summarise()\n\nrius_filtrat <- rius_agrupat |> \n  filter(as.numeric(st_length(`_ogr_geometry_`)) >= 100000) # filtrar per conques de menys de 100 km\n```\n:::\n\n::: {.cell .caption-margin}\n\n```{.r .cell-code}\nmap <- tm_shape(bm) + \n  tm_rgb(alpha = 0.2) + \n  tm_shape(rius_filtrat) + \n  tm_lines(col = \"conca\",\n           palette = \"viridis\",\n           legend.col.show = FALSE) + \n  tm_layout(frame = FALSE)\nmap\n```\n\n::: {.cell-output-display}\n![Les 14 principals conques hidrogràfiques de Catalunya\\nFont Col·laboradors d'OpenStreetMap](20230208_files/figure-html/unnamed-chunk-6-1.png){width=960}\n:::\n:::\n",
    "supporting": [
      "20230208_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}