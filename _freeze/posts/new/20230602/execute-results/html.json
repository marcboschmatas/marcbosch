{
  "hash": "8df7460afbc0d171935c34282da2cb8c",
  "result": {
    "markdown": "---\ntitle: \"Municipals 2023 a Barcelona: on es vota més semblant a la ciutat?\"\nauthor: \"Marc Bosch\"\ndate: \"2023-02-06\"\ncategories: [R, ggplot2, tmap, sf, eleccions]\nexecute:\n  warning: false\n  error: false\n  message: false\nformat:\n  html: \n    code-fold: true\n    code-summary: \"Show the code\"\n    fig-width: 15\n---\n\n\n\nDiumenge passat van ser eleccions: més enllà de si estem contents o no dels resultats, em feia una pregunta: on voten més semblant al resultat global de la ciutat?\nAquí mirarem quins districtes, barris i seccions censals s'assemblen més al resultat final de la ciutat tenint en compte només els vots a partits amb més d'un 3% de vot i vots en blanc.\n### Com vam votar?\n\nPer gent despistada, recordem els resultats a nivell de ciutat.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(tmap)\nlibrary(modthemes)\n\nrestot <- read.csv(\"https://opendata-ajuntament.barcelona.cat/data/dataset/78d2734c-35ee-49de-86c6-4bafef2e8e05/resource/ece25812-297e-49c9-8907-526797731fc8/download/2023_eleccions_locals.csv\")\nunitats <- st_read(\"/home/marc/sessio_mapes_3/data/BCN_UNITATS_ADM/0301100100_UNITATS_ADM_POLIGONS.json\", quiet = TRUE)\nres_ciutat <- restot |> \n  group_by(Camp) |> \n  summarise(res = sum(Nombre)) |> \n  ungroup() |> \n  pivot_wider(names_from = Camp, values_from = res) |> \n  select(-c(Electors, Votants, Nuls)) |> \n  mutate(across(-`Vots vàlids`, \\(x) x/`Vots vàlids`)) |> \n  select(-`Vots vàlids`) |> \n  pivot_longer(everything(), names_to = \"camp\", values_to = \"res\") |> \n  filter(res >= .03 | camp == \"Blancs\")\npalette_partits <- c(\"PSC-CP\" = \"#E73B39\", \"TriasxBCN\" = \"#00C3B2\",\n                     \"ERC-AM\" = \"#FFB232\", \"BCOMU-C\" = \"#E65C56\",\n                     \"PP\" = \"#0bb2ff\", \"VOX\" = \"#63BE21\",\n                     \"CUP-AMUNT\" = \"#ffed00\", \"Blancs\" = \"gray\")\nggplot(res_ciutat, aes(reorder(camp, res), res, fill = camp)) + \n  geom_bar(stat = \"identity\") + \n  scale_fill_manual(\"\", values = palette_partits) + \n  scale_y_continuous(labels = scales::label_percent()) + \n  theme_minimal() + \n  theme(axis.title.x = element_blank(),\n        axis.title.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](20230602_files/figure-html/unnamed-chunk-1-1.png){width=1440}\n:::\n:::\n\n\n\nFins aquí molt bé. Ara toca mesurar la diferència amb districtes, barris i seccions censals. Com ho fem? Doncs prou senzill: calculant la diferència en valor absolut entre el percentatge a nivell de districte, barri o secció censal i el total de la ciutat i sumant-ho. Com més alt és el resultat, més diferència.\n\n$dif = \\sum_{i = 1}^{n}  |x_i - xciutat_i|$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres_ciutat <- rename(res_ciutat, \"res_ciutat\" = \"res\")\n\nres_districte <- restot |> \n  group_by(Camp, Nom_Districte) |> \n  summarise(res = sum(Nombre)) |> \n  ungroup() |> \n  pivot_wider(id_cols = Nom_Districte, names_from = Camp, values_from = res) |> \n  select(-c(Electors, Votants, Nuls)) |> \n  mutate(across(-c(`Vots vàlids`, Nom_Districte), \\(x) x/`Vots vàlids`)) |> \n  select(-`Vots vàlids`) |> \n  pivot_longer(-Nom_Districte, names_to = \"camp\", values_to = \"res\") |> \n  left_join(res_ciutat, by = \"camp\") |> \n  filter(res_ciutat >= .03 | camp == \"Blancs\") |> \n  mutate(absdif = abs(res-res_ciutat)) |> \n  group_by(Nom_Districte) |> \n  summarise(dif = sum(absdif))\n\nres_barri <- restot |> \n  group_by(Camp, Nom_Barri) |> \n  summarise(res = sum(Nombre)) |> \n  ungroup() |> \n  pivot_wider(id_cols = Nom_Barri, names_from = Camp, values_from = res) |> \n  select(-c(Electors, Votants, Nuls)) |> \n  mutate(across(-c(`Vots vàlids`, Nom_Barri), \\(x) x/`Vots vàlids`)) |> \n  select(-`Vots vàlids`) |> \n  pivot_longer(-Nom_Barri, names_to = \"camp\", values_to = \"res\") |> \n  left_join(res_ciutat, by = \"camp\") |> \n  filter(res_ciutat >= .03 | camp == \"Blancs\") |> \n  mutate(absdif = abs(res-res_ciutat)) |> \n  group_by(Nom_Barri) |> \n  summarise(dif = sum(absdif))\n\nres_seccens <- restot |> \n  pivot_wider(id_cols = c(Nom_Districte, Nom_Barri, Seccio_Censal), names_from = Camp, values_from = Nombre) |>  \n  select(-c(Electors, Votants, Nuls)) |> \n  mutate(across(-c(`Vots vàlids`, Nom_Barri, Nom_Districte, Seccio_Censal), \\(x) x/`Vots vàlids`)) |> \n  select(-`Vots vàlids`) |> \n  pivot_longer(-c(Nom_Districte, Nom_Barri, Seccio_Censal), names_to = \"camp\", values_to = \"res\") |> \n  left_join(res_ciutat, by = \"camp\") |> \n  filter(res_ciutat >= .03 | camp == \"Blancs\") |> \n  mutate(absdif = abs(res-res_ciutat)) |> \n  group_by(Nom_Districte, Nom_Barri, Seccio_Censal) |> \n  summarise(dif = sum(absdif))\n```\n:::\n\n\n\n\n### Districtes\n\n\n\n::: {.cell fit-height='8'}\n\n```{.r .cell-code}\nunitats |> \n  filter(SCONJ_DESC == \"Districte\") |> \n  select(NOM) |> \n  left_join(res_districte, by = c(\"NOM\" = \"Nom_Districte\")) |> \n  tm_shape() + \n  tm_polygons(col = \"dif\",\n              palette = \"viridis\") + \n  tm_layout(frame = FALSE,\n            legend.format=list(fun=function(x) round(x*100,0)))\n```\n\n::: {.cell-output-display}\n![](20230602_files/figure-html/unnamed-chunk-3-1.png){width=768}\n:::\n:::\n\n\n\nSense cap sorpresa, Sarrià-Sant Gervasi i Nou Barris tenen les diferències més grans. Horta-Guinardó i Sant Martí les més petites. Malgrat tot, un districte és molt gran i molt divers: què passa si ho mirem a nivell de barri?\n\n\n### Barris\n\n\n::: {.cell fit-height='8'}\n\n```{.r .cell-code}\nunitats |> \n  filter(SCONJ_DESC == \"Barri\") |> \n  select(NOM) |> \n  left_join(res_barri, by = c(\"NOM\" = \"Nom_Barri\")) |> \n  tm_shape() + \n  tm_polygons(col = \"dif\",\n              palette = \"viridis\") + \n  tm_layout(frame = FALSE,\n            legend.format=list(fun=function(x) x*100))\n```\n\n::: {.cell-output-display}\n![](20230602_files/figure-html/unnamed-chunk-4-1.png){width=768}\n:::\n:::\n\n\nVaja, la cosa canvia força, no? Veiem que les diferències més grans ara són explícitament a Pedralbes i a les Tres Torres (més grans del 70%!) i les més petites a la Vila Olímpica, Can Baró i Navas. La resta de Sarrià-Sant Gervasi tenen diferències força grans i a Nou Barris ronden entre el 30 i el 60%. Cap sorpresa, tampoc.\n\n### Seccions censals\n\nAnem al detall: quines meses electorals són més semblants a tota la ciutat? A quins col·legis les sensacions dels apoderats van ser les més encertades?\n\n\n\n::: {.cell fit-height='8'}\n\n```{.r .cell-code}\n# codis de districte i barri\n\ncodis <- unitats |> \n  st_drop_geometry() |> \n  filter(SCONJ_DESC == \"Districte\") |> \n  select(NOM, DISTRICTE) |> \n  rename(\"Nom_Districte\" = \"NOM\")\ncoba <- unitats |> \n  st_drop_geometry() |> \n  filter(SCONJ_DESC == \"Barri\") |> \n  select(NOM, BARRI) |> \n  rename(\"Nom_Barri\" = \"NOM\")\n\nres_seccens <- res_seccens |> \n  left_join(codis, by = \"Nom_Districte\") |> \n  left_join(coba, by = \"Nom_Barri\") |> \n  mutate(Seccio_Censal = str_pad(Seccio_Censal, 3, pad = 0))\n\nunitats |> \n  filter(SCONJ_DESC == \"Secció censal\") |> \n  left_join(rename(res_seccens, \"SEC_CENS\" = \"Seccio_Censal\"),  by = c(\"SEC_CENS\", \"BARRI\", \"DISTRICTE\")) |> \n  tm_shape() + \n  tm_fill(col = \"dif\",\n              palette = \"viridis\",\n              n = 8) + \n  tm_layout(frame = FALSE,\n            legend.format=list(fun=function(x) x*100))\n```\n\n::: {.cell-output-display}\n![](20230602_files/figure-html/unnamed-chunk-5-1.png){width=768}\n:::\n:::\n\n\n\n\nPer seccions, veiem exactament el mateix però apareixen algunes seccions censals amb més diferències a Sant Gervasi-Galvany amb diferències de més de 80 punts percentuals. Ara, on són les seccions censals amb menys diferència?\n\n\n\n::: {.cell fit-height='8'}\n\n```{.r .cell-code}\nsec_mdif <- unitats |> \n  filter(SCONJ_DESC == \"Secció censal\") |> \n  left_join(rename(res_seccens, \"SEC_CENS\" = \"Seccio_Censal\"),  by = c(\"SEC_CENS\", \"BARRI\", \"DISTRICTE\")) |> \n  filter(dif <= 0.1)\n\nunitats |> \n  filter(SCONJ_DESC == \"Barri\") |> \n  tm_shape() + \n  tm_borders() + \n  tm_shape(sec_mdif) + \n  tm_polygons(col = \"red4\") + \n  tm_layout(frame = FALSE)\n```\n\n::: {.cell-output-display}\n![](20230602_files/figure-html/unnamed-chunk-6-1.png){width=768}\n:::\n:::\n\n\n\nEn veiem unes quantes a Sants i a Les Corts i en dues línies verticals al Baix Guinardó, la Dreta de l'Eixample, la Sagrada Família, el Fort Pienc i Navas i el Congrés i els Indians.\n\nAixí, quin recompte haurem d'anar a veure el 2027 si volem saber què sortirà? Comptant que les coses no canviïn gaire, aquí en teniu uns quants.\n",
    "supporting": [
      "20230602_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}