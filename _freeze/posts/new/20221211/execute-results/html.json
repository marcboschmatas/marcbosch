{
  "hash": "0b6aeb278d7649d623d12c379087ca7d",
  "result": {
    "markdown": "---\ntitle: \"Reutilitzant dades públiques: escoles a OpenStreetMap\"\nauthor: \"Marc Bosch Matas\"\ndate: \"2022-12-11\"\ncategories: [OpenStreetMap, OpenData, Dades Obertes, R]\nexecute:\n  warning: false\n  error: false\n  message: false\nformat:\n  html: \n    code-fold: true\n    code-summary: \"Codi R\"\n---\n\n\nAvui comparteixo una de les coses que faig quan la vida em deixa: editar OpenStreetMap. Si coneixeu aquest projecte, consisteix en una gran base de dades geolocalitzada que editem persones de tot arreu utilitzant fonts de coneixement lliures. Bàsicament ho faig per activisme: OpenStreetMap pot ser una alternativa a Google Maps i altres projectes que donen beneficis a les grans tecnològiques. No corre el risc que ho compri l'Elon Musk de torn ni de patir censures arbitràries. Més important, qualsevol persona el pot editar, i el criteri de què és important el marquem les persones que hi participem. D'altra banda, els editors i editores catalans som una colla de gent bastant simpàtica i ens toca més l'aire que si editéssim la Viquipèdia. D'altra banda, també fem molta cosa amb ordinadors per tenir el màxim de dades possibles amb el mínim esforç.\n\nFa no massa, vam obtenir permís per fer servir el [Directori de Centres Educatius](https://analisi.transparenciacatalunya.cat/Educaci-/Directori-de-centres-docents-anual-Base-2020/kvmv-ahh4) del Departament d'Educació. En aquest post, explicaré com agafem les dades i les preparem per a pujar-les a OpenStreetMap. Per exemple, amb el cas de Palafrugell. Així, el que farem serà el següent.\n\n1) Baixar totes les dades de centres educatius de Palafrugell que tenen un número de referència del departament d'Educació utilitzant l'API Overpass.\n\n2) Baixar les dades del Directori de Centres correspondent als centres que volem completar.\n\n3) Tractar les dades i afegir les que falten a la taula d'OpenStreetMap.\n\n4) Comprovar que tot estigui bé i pujar les dades fent servir l'editor JOSM.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf) # tractar shapefiles\nlibrary(osmdata) # baixar data d'OSM\nlibrary(tmap) # fer mapes\nlibrary(tmaptools) # baixar mapa base\nlibrary(tidyverse) # tractar taules\nlibrary(httr) # baixar dades d'internet\nlibrary(jsonlite) # convertir JSONs a taules\nlibrary(rvest) # llegir webs\n```\n:::\n\n\n\n\nComencem per baixar les dades d'OpenStreetMap i representar-les en un mapa.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nescoles <- opq(\"Palafrugell\") |> \n  add_osm_features(\"[\\\"amenity\\\"=\\\"school\\\"][\\\"ref\\\"]\") |> # this is a lot more cumbersome but allows to filter for missing tags\n  osmdata_sf()\n\nescoles_punts <- escoles$osm_points\nescoles_pol <- escoles$osm_polygons\nescoles_mpol <- escoles$osm_multipolygons\n\nescoles_osm <- escoles_pol |> \n  st_drop_geometry() |> \n  bind_rows(st_drop_geometry(escoles_mpol))\nknitr::kable(escoles_osm, style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|           |osm_id     |name                               |addr.city   |addr.housenumber |addr.postcode |addr.street                     |amenity |leisure |name.ca              |name.etymology.wikidata |operator                  |ref      |religion  |sport  |surface  |website                           |wheelchair |wikidata   |wikipedia             |type         |\n|:----------|:----------|:----------------------------------|:-----------|:----------------|:-------------|:-------------------------------|:-------|:-------|:--------------------|:-----------------------|:-------------------------|:--------|:---------|:------|:--------|:---------------------------------|:----------|:----------|:---------------------|:------------|\n|167703123  |167703123  |Escola Josep Barceló i Matas       |NA          |NA               |NA            |NA                              |school  |NA      |NA                   |Q19300295               |NA                        |17002491 |NA        |NA     |NA       |NA                                |NA         |Q111283965 |NA                    |NA           |\n|235507099  |235507099  |Vedruna Palafrugell                |NA          |NA               |NA            |NA                              |school  |NA      |Vedruna Palafrugell  |NA                      |NA                        |17002511 |NA        |NA     |NA       |NA                                |NA         |Q111594946 |NA                    |NA           |\n|367243676  |367243676  |Escola Carrilet                    |NA          |NA               |NA            |NA                              |school  |NA      |Escola Carrilet      |NA                      |Ajuntament de Palafrugell |17006782 |NA        |NA     |NA       |NA                                |yes        |Q111283756 |NA                    |NA           |\n|367352591  |367352591  |NA                                 |NA          |NA               |NA            |NA                              |NA      |NA      |NA                   |NA                      |NA                        |NA       |NA        |NA     |NA       |NA                                |NA         |NA         |NA                    |NA           |\n|367693485  |367693485  |NA                                 |NA          |NA               |NA            |NA                              |NA      |pitch   |NA                   |NA                      |NA                        |NA       |NA        |soccer |concrete |NA                                |NA         |NA         |NA                    |NA           |\n|367714709  |367714709  |Institut Baix Empordà              |NA          |NA               |NA            |NA                              |school  |NA      |NA                   |NA                      |Generalitat de Catalunya  |17002557 |NA        |NA     |NA       |NA                                |yes        |Q11926287  |NA                    |NA           |\n|367729357  |367729357  |Escola Sant Jordi                  |NA          |NA               |NA            |NA                              |school  |NA      |Escola Sant Jordi    |NA                      |NA                        |17002521 |NA        |NA     |NA       |NA                                |NA         |Q111594947 |NA                    |NA           |\n|368163468  |368163468  |Escola Torres Jonama               |NA          |NA               |NA            |NA                              |school  |NA      |Escola Torres Jonama |NA                      |Generalitat de Catalunya  |17002481 |NA        |NA     |NA       |NA                                |yes        |Q11910302  |ca:CEIP Torres Jonama |NA           |\n|816953410  |816953410  |Escola l'Olivar Vell               |Esclanyà    |NA               |NA            |NA                              |school  |NA      |Escola l'Olivar Vell |NA                      |NA                        |17004876 |NA        |NA     |NA       |NA                                |NA         |Q111283738 |NA                    |NA           |\n|1015010006 |1015010006 |Escola Pi Verd                     |Palafrugell |12               |17200         |Carrer de Viçens Roure i Armadà |school  |NA      |Escola Pi Verd       |NA                      |NA                        |17008523 |christian |NA     |NA       |https://agora.xtec.cat/escpiverd/ |NA         |Q111283815 |NA                    |NA           |\n|5465679    |5465679    |Institut Frederic Martí i Carreras |NA          |NA               |NA            |NA                              |school  |NA      |NA                   |Q11923061               |Generalitat de Catalunya  |17002545 |NA        |NA     |NA       |NA                                |yes        |Q111253680 |NA                    |multipolygon |\n:::\n:::\n\n::: {.cell layout-align=\"right\"}\n\n```{.r .cell-code}\nbm <- read_osm(escoles_punts)\n\ntm_shape(bm) + \n  tm_rgb() + \n  tm_shape(escoles_pol) + \n  tm_borders(col = modthemes::dubois_blue,\n             lwd = 2) + \n  tm_shape(escoles_mpol) + \n  tm_borders(col = modthemes::dubois_blue,\n             lwd = 2)\n```\n\n::: {.cell-output-display}\n![](20221211_files/figure-html/unnamed-chunk-3-1.png){fig-align='right' width=672}\n:::\n:::\n\n\nVeiem que ens surten alguns objectes sense codi de referència, però no ens hauria de preocupar massa. Són objectes com patis o pistes poliesportives que formen part de les relacions (és a dir, col·leccions d'objectes) de les escoles. Ara toca baixar-nos les dades del Departament d'Educació. Ho fem amb les llibreries ```httr``` i ```jsonlite``` que ens permeten crear [una URL](https://analisi.transparenciacatalunya.cat/resource/kvmv-ahh4.json?$query=SELECT%20*%20WHERE%20codi_centre%20IN%20('17002491',%20'17002511',%20'17006782',%20'17002557',%20'17002521',%20'17002481',%20'17004876',%20'17008523',%20'17002545')%20AND%20curs='2022/2023') on hi hagi les dades de tots els centres que ens interessen, baixar-nos la informació i organitzar-la en forma de taula. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# crear vector de codis únics\nrefs <- unique(c(escoles_pol$ref, escoles_mpol$ref))\nrefs <- refs[!is.na(refs)]\n# crear una variable character amb tots els codis separats per codis\nreftext <- sapply(refs, \\(x) paste0(\"'\",str_pad(x, width=8, pad = 0),\"'\")) |> \n  paste(collapse = \", \")\n\n# generar una url de l'API de dades obertes de la Generalitat que ens\nbaseurl <- \"https://analisi.transparenciacatalunya.cat/resource/kvmv-ahh4.json?$query=\"\n\n\nquery = paste0(\"SELECT * WHERE codi_centre IN (\", reftext, \") AND curs='2022/2023'\")\nquery <- str_replace_all(query,\" \",\"%20\")\n\n# descarregar les dades i passar-les a format taula\nescoles_gene <- GET(paste0(baseurl,query)) |> \n  content(as = \"text\") |> \n  fromJSON()\n\nknitr::kable(escoles_gene, style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|curs      |any  |codi_centre |denominaci_completa                |codi_naturalesa |nom_naturalesa |codi_titularitat |nom_titularitat           |adre_a                             |codi_postal |tel_fon   |fax       |codi_delegaci |nom_delegaci |codi_comarca |nom_comarca  |codi_municipi |codi_municipi_6 |nom_municipi |codi_districte_municipal |codi_localitat |nom_localitat |zona_educativa |coordenades_utm_x |coordenades_utm_y |coordenades_geo_x |coordenades_geo_y |e_mail_centre     |url                                               |einf2c |epri |einf1c |eso |batx |cfpm |aa03 |cfps |pfi |\n|:---------|:----|:-----------|:----------------------------------|:---------------|:--------------|:----------------|:-------------------------|:----------------------------------|:-----------|:---------|:---------|:-------------|:------------|:------------|:------------|:-------------|:---------------|:------------|:------------------------|:--------------|:-------------|:--------------|:-----------------|:-----------------|:-----------------|:-----------------|:-----------------|:-------------------------------------------------|:------|:----|:------|:---|:----|:----|:----|:----|:---|\n|2022/2023 |2022 |17002481    |Escola Torres Jonama               |1               |Públic         |01               |Departament d'Ensenyament |c. Escoles, 10                     |17200       |972610882 |972610652 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |513844            |4640216           |3.166934          |41.913774         |b7002481@xtec.cat |http://www.xtec.cat/ceiptorresjonama-palafrugell/ |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17002491    |Escola Josep Barceló i Matas       |1               |Públic         |01               |Departament d'Ensenyament |c. Pals, 75                        |17200       |972300924 |972300924 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |513374            |4640994           |3.16129           |41.920784         |b7002491@xtec.cat |http://agora.xtec.cat/ceipbarceloimatas/          |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17002511    |Vedruna Palafrugell                |2               |Privat         |22               |Fundacions                |c. Sant Sebastià, 85               |17200       |972300739 |972300303 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |514063            |4640552           |3.169588          |41.916794         |b7002511@xtec.cat |http://WWW.vedrunapalafrugell.org                 |EINF2C |EPRI |EINF1C |NA  |NA   |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17002521    |Sant Jordi                         |2               |Privat         |26               |Societats Mercantils      |c. Tarongeta, 65                   |17200       |972302898 |972304238 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |513935            |4640611           |3.168046          |41.91733          |b7002521@xtec.cat |http://www.escolasantjordi.cat                    |EINF2C |EPRI |NA     |ESO |NA   |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17002545    |Institut Frederic Martí i Carreras |1               |Públic         |01               |Departament d'Ensenyament |c. Frederic Martí Carreras, 13     |17200       |972301079 |972611336 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |513680            |4639998           |3.164958          |41.911812         |b7002545@xtec.cat |http://agora.xtec.cat/iesfredericmarti/           |NA     |NA   |NA     |ESO |BATX |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17002557    |Institut Baix Empordà              |1               |Públic         |01               |Departament d'Ensenyament |av. de les Corts Catalanes, s/n    |17200       |972300323 |972611874 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |513786            |4639842           |3.166224          |41.910404         |b7002557@xtec.cat |http://www.insbaixemporda.cat                     |NA     |NA   |NA     |ESO |BATX |CFPM |AA03 |CFPS |PFI |\n|2022/2023 |2022 |17004876    |Escola l'Olivar Vell               |1               |Públic         |01               |Departament d'Ensenyament |Veïnat Colomina, s/n               |17255       |972611990 |972611990 |0117          |Girona       |10           |Baix Empordà |17013         |170139          |Begur        |00                       |02             |Esclanyà      |Baix Empordà   |514364            |4642168           |3.173253          |41.931346         |b7004876@xtec.cat |https://agora.xtec.cat/ceipolivarvell/            |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17006782    |Escola Carrilet                    |1               |Públic         |01               |Departament d'Ensenyament |pl. Narcisa Oliver i Deulofeu, s/n |17200       |972306765 |972306770 |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |512884            |4639998           |3.155351          |41.911822         |b7006782@xtec.cat |http://agora.xtec.cat/escolacarrilet/             |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |\n|2022/2023 |2022 |17008523    |Escola Pi Verd                     |1               |Públic         |01               |Departament d'Ensenyament |c. Vicenç Roure i Armadà, 12       |17200       |972610457 |NA        |0117          |Girona       |10           |Baix Empordà |17117         |171175          |Palafrugell  |00                       |06             |Palafrugell   |Baix Empordà   |514349            |4640814           |3.173042          |41.919148         |b7008523@xtec.cat |http://agora.xtec.cat/escpiverd/                  |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |\n:::\n:::\n\n\n\nTenim un munt de variables, moltes de les quals ens interessen. Algunes les podem incorporar tal i com van i d'altres voldran una mica de feina. Comencem per l'adreça. Veiem que hi ha quatre camps vinculats amb l'adreça: ```addr.city```, ```addr.housenumber``` (número d'edifici), ```addr.postcode``` (codi postal) i ```addr.street``` (carrer). D'altra banda, podem agafar directament la web, el correu electrònic i  com el nom del titular. La titularitat també es pot agafar directament, però cal traduir-ho a l'anglès. També cal afegir els prefixos internacionals als camps de telèfon i fax.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nescoles_gene_osm <- escoles_gene |> \n  select(-c(curs, codi_titularitat, codi_naturalesa, \n            codi_delegaci, nom_delegaci, codi_comarca,\n            codi_municipi, codi_municipi_6, \n            codi_localitat, codi_districte_municipal, \n            nom_comarca, zona_educativa,\n            coordenades_utm_x, coordenades_utm_y,\n            coordenades_geo_x, coordenades_geo_y)) |> # eliminar columnes que no calen\n  rename(\"operator\" = \"nom_titularitat\",\n         \"name\" = \"denominaci_completa\",\n         \"ref\" = \"codi_centre\",\n         \"contact:phone\" = \"tel_fon\",\n         \"contact:fax\" = \"fax\",\n         \"contact:email\" = \"e_mail_centre\",\n         \"website\" = \"url\",\n         \"addr:city\" = \"nom_municipi\",\n         \"addr:place\" = \"nom_localitat\",\n         \"addr:postcode\" = \"codi_postal\",\n         \"source:date\" = \"any\") |> # canviar noms de columnes que podem adaptar \"tal qual\"\n  mutate(\"contact:fax\" = paste0(\"+34\",`contact:fax`),\n         \"contact:phone\" = paste0(\"+34\", `contact:phone`),\n         \"addr:street\" = str_extract(adre_a, \"^[^\\\\,]+\"),\n         \"addr:housenumber\" = str_extract(adre_a, \"[^\\\\, ]+$\"),\n         \"operator:type\" = ifelse(nom_naturalesa == \"Públic\", \"public\", \"private\"))\nknitr::kable(escoles_gene_osm, style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|source:date |ref      |name                               |nom_naturalesa |operator                  |adre_a                             |addr:postcode |contact:phone |contact:fax  |addr:city   |addr:place  |contact:email     |website                                           |einf2c |epri |einf1c |eso |batx |cfpm |aa03 |cfps |pfi |addr:street                   |addr:housenumber |operator:type |\n|:-----------|:--------|:----------------------------------|:--------------|:-------------------------|:----------------------------------|:-------------|:-------------|:------------|:-----------|:-----------|:-----------------|:-------------------------------------------------|:------|:----|:------|:---|:----|:----|:----|:----|:---|:-----------------------------|:----------------|:-------------|\n|2022        |17002481 |Escola Torres Jonama               |Públic         |Departament d'Ensenyament |c. Escoles, 10                     |17200         |+34972610882  |+34972610652 |Palafrugell |Palafrugell |b7002481@xtec.cat |http://www.xtec.cat/ceiptorresjonama-palafrugell/ |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |c. Escoles                    |10               |public        |\n|2022        |17002491 |Escola Josep Barceló i Matas       |Públic         |Departament d'Ensenyament |c. Pals, 75                        |17200         |+34972300924  |+34972300924 |Palafrugell |Palafrugell |b7002491@xtec.cat |http://agora.xtec.cat/ceipbarceloimatas/          |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |c. Pals                       |75               |public        |\n|2022        |17002511 |Vedruna Palafrugell                |Privat         |Fundacions                |c. Sant Sebastià, 85               |17200         |+34972300739  |+34972300303 |Palafrugell |Palafrugell |b7002511@xtec.cat |http://WWW.vedrunapalafrugell.org                 |EINF2C |EPRI |EINF1C |NA  |NA   |NA   |NA   |NA   |NA  |c. Sant Sebastià              |85               |private       |\n|2022        |17002521 |Sant Jordi                         |Privat         |Societats Mercantils      |c. Tarongeta, 65                   |17200         |+34972302898  |+34972304238 |Palafrugell |Palafrugell |b7002521@xtec.cat |http://www.escolasantjordi.cat                    |EINF2C |EPRI |NA     |ESO |NA   |NA   |NA   |NA   |NA  |c. Tarongeta                  |65               |private       |\n|2022        |17002545 |Institut Frederic Martí i Carreras |Públic         |Departament d'Ensenyament |c. Frederic Martí Carreras, 13     |17200         |+34972301079  |+34972611336 |Palafrugell |Palafrugell |b7002545@xtec.cat |http://agora.xtec.cat/iesfredericmarti/           |NA     |NA   |NA     |ESO |BATX |NA   |NA   |NA   |NA  |c. Frederic Martí Carreras    |13               |public        |\n|2022        |17002557 |Institut Baix Empordà              |Públic         |Departament d'Ensenyament |av. de les Corts Catalanes, s/n    |17200         |+34972300323  |+34972611874 |Palafrugell |Palafrugell |b7002557@xtec.cat |http://www.insbaixemporda.cat                     |NA     |NA   |NA     |ESO |BATX |CFPM |AA03 |CFPS |PFI |av. de les Corts Catalanes    |s/n              |public        |\n|2022        |17004876 |Escola l'Olivar Vell               |Públic         |Departament d'Ensenyament |Veïnat Colomina, s/n               |17255         |+34972611990  |+34972611990 |Begur       |Esclanyà    |b7004876@xtec.cat |https://agora.xtec.cat/ceipolivarvell/            |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |Veïnat Colomina               |s/n              |public        |\n|2022        |17006782 |Escola Carrilet                    |Públic         |Departament d'Ensenyament |pl. Narcisa Oliver i Deulofeu, s/n |17200         |+34972306765  |+34972306770 |Palafrugell |Palafrugell |b7006782@xtec.cat |http://agora.xtec.cat/escolacarrilet/             |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |pl. Narcisa Oliver i Deulofeu |s/n              |public        |\n|2022        |17008523 |Escola Pi Verd                     |Públic         |Departament d'Ensenyament |c. Vicenç Roure i Armadà, 12       |17200         |+34972610457  |+34NA        |Palafrugell |Palafrugell |b7008523@xtec.cat |http://agora.xtec.cat/escpiverd/                  |EINF2C |EPRI |NA     |NA  |NA   |NA   |NA   |NA   |NA  |c. Vicenç Roure i Armadà      |12               |public        |\n:::\n:::\n\n\n\nVeureu per això, que he deixat unes quantes columnes sense tractar, que tenen a veure amb quins cicles imparteixen. A partir d'això, cal generar tres variables més. ```isced:level```, que estandarditza els nivells d'educació a nivell mundial (podeu veure'n totes les equivalències [aquí](http://uis.unesco.org/sites/default/files/documents/international-standard-classification-of-education-1997-en_0.pdf)), ```min_age``` (edat mínima), ```max_age``` (edat màxima), ```school``` el tipus d'escola i ```amenity``` on distingim entre escoles bressol, escoles de música elementals, d'idiomes o escoles de qualsevol altre tipus. Primer de tot, copiem la taula d'equivalències de la [wiki d'OpenStreetMap.](https://wiki.openstreetmap.org/wiki/Import_schools_in_Catalunya)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neqs <- \"https://wiki.openstreetmap.org/wiki/Import_schools_in_Catalunya\" |> \n  read_html() |> \n  html_nodes(xpath = '/html/body/div[3]/div[3]/div[5]/div[1]/table[2]') |> \n  html_table()\neqs <- eqs[[1]] |> \n  mutate(Cycle = str_split(Cycle, \", \")) |> \n  unnest(cols = Cycle) |> \n  mutate(Cycle = str_to_lower(Cycle))\nknitr::kable(eqs, style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|Cycle  |ISCED level | min_age| max_age|\n|:------|:-----------|-------:|-------:|\n|einf1c |0           |       0|       3|\n|einf2c |1           |       3|       6|\n|epri   |1           |       6|      12|\n|eso    |2           |      12|      16|\n|batx   |3           |      16|      18|\n|aa01   |2           |      NA|      NA|\n|cfpm   |3           |      16|      NA|\n|cfam   |3           |      16|      NA|\n|tegm   |3           |      16|      NA|\n|pa01   |3           |      16|      NA|\n|ppas   |3           |      16|      NA|\n|aa03   |3           |      16|      NA|\n|cfps   |5           |      18|      NA|\n|cfas   |5           |      18|      NA|\n|esdi   |5           |      18|      NA|\n|dans   |5           |      18|      NA|\n|muss   |5           |      18|      NA|\n|tegs   |5           |      18|      NA|\n|pa02   |5           |      18|      NA|\n|adr    |5           |      18|      NA|\n|crbc   |5           |      18|      NA|\n|pfi    |2           |      16|      21|\n|dane   |1; 2        |      NA|      NA|\n|muse   |1; 2        |      NA|      NA|\n|danp   |2; 3        |      12|      18|\n|musp   |2; 3        |      12|      18|\n|estr   |            |      NA|      NA|\n|idi    |            |      16|      NA|\n|adults |1; 2; 3     |      18|      NA|\n|ee     |1; 2        |       3|      NA|\n:::\n:::\n\n\n\n\nAra ja podem generar les columnes que falten.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nescoles_gene_isced <- escoles_gene |> \n  select(\"codi_centre\", \"epri\", \"einf1c\", \"einf2c\", \"eso\", \"batx\", \"cfpm\", \"aa03\", \"cfps\", \"pfi\") |> \n  pivot_longer(-codi_centre,\n               names_to = \"level_name\",\n               values_to = \"junk\") |> \n  filter(!is.na(junk)) |> \n  select(-junk) |> \n  left_join(eqs, by = c(\"level_name\" = \"Cycle\")) |> \n  mutate(\"school\" = case_when(level_name %in% c(\"einf1c\", \"einf2c\") ~ NA_character_,\n                              level_name == \"epri\" ~ \"primary\",\n                              level_name %in% c(\"eso\", \"batx\") ~ \"secondary\",\n                              level_name %in% c(\"aa01\", \"cfpm\", \"ppas\", \n                                                \"aa03\", \"cfps\", \"pfi\", \"pa01\",\n                                                \"cfam\", \"pa02\", \"cfas\",\n                                                \"esdi\", \"adr\", \"crbc\",\n                                                \"dans\", \"musp\", \"muss\",\n                                                \"tegm\", \"tegs\") ~ \"professional\",\n                              level_name == \"ee\" ~ \"special_education_needs\",\n                              TRUE ~ NA_character_),\n         \"amenity\" = case_when(level_name %in% c(\"einf1c\", \"einf2c\") ~ \"kindergarten\",\n                               level_name == \"muse\" ~ \"music_school\",\n                               level_name == \"dane\" ~ NA_character_,\n                               level_name == \"idi\" ~ \"language_school\",\n                               TRUE ~ \"school\")) |> \n  arrange(`ISCED level`) |> \n  group_by(codi_centre) |> \n  summarise(\"isced:level\" = paste(unique(`ISCED level`), collapse = \"; \"),\n            \"min_age\" = min(min_age),\n            \"max_age\" = ifelse(length(c(max_age)[is.na(c(max_age))]) > 0, NA_integer_,max(max_age)),\n            \"amenity\" = paste(unique(`amenity`), collapse = \"; \"),\n            \"school\" = paste(unique(school)[!is.na(c(unique(school)))], collapse = \"; \"))\nknitr::kable(escoles_gene_isced, style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|codi_centre |isced:level | min_age| max_age|amenity              |school                  |\n|:-----------|:-----------|-------:|-------:|:--------------------|:-----------------------|\n|17002481    |1           |       3|      12|school; kindergarten |primary                 |\n|17002491    |1           |       3|      12|school; kindergarten |primary                 |\n|17002511    |0; 1        |       0|      12|kindergarten; school |primary                 |\n|17002521    |1; 2        |       3|      16|school; kindergarten |primary; secondary      |\n|17002545    |2; 3        |      12|      18|school               |secondary               |\n|17002557    |2; 3; 5     |      12|      NA|school               |secondary; professional |\n|17004876    |1           |       3|      12|school; kindergarten |primary                 |\n|17006782    |1           |       3|      12|school; kindergarten |primary                 |\n|17008523    |1           |       3|      12|school; kindergarten |primary                 |\n:::\n:::\n\n\n\nAra només queda generar una taula única i ja tenim totes les dades preparades per a importar-les a OpenStreetMap amb JOSM o qualsevol altra eina.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nescoles_gene_osm <- escoles_gene_osm |> \n  select(-c(\"epri\", \"einf1c\", \"einf2c\", \"eso\", \"batx\", \"cfpm\", \"aa03\", \"cfps\", \"pfi\", \"nom_naturalesa\", \"adre_a\")) |> \n  left_join(escoles_gene_isced, by = c(\"ref\" = \"codi_centre\"))\nknitr::kable(escoles_gene_osm, style = \"pipe\")\n```\n\n::: {.cell-output-display}\n|source:date |ref      |name                               |operator                  |addr:postcode |contact:phone |contact:fax  |addr:city   |addr:place  |contact:email     |website                                           |addr:street                   |addr:housenumber |operator:type |isced:level | min_age| max_age|amenity              |school                  |\n|:-----------|:--------|:----------------------------------|:-------------------------|:-------------|:-------------|:------------|:-----------|:-----------|:-----------------|:-------------------------------------------------|:-----------------------------|:----------------|:-------------|:-----------|-------:|-------:|:--------------------|:-----------------------|\n|2022        |17002481 |Escola Torres Jonama               |Departament d'Ensenyament |17200         |+34972610882  |+34972610652 |Palafrugell |Palafrugell |b7002481@xtec.cat |http://www.xtec.cat/ceiptorresjonama-palafrugell/ |c. Escoles                    |10               |public        |1           |       3|      12|school; kindergarten |primary                 |\n|2022        |17002491 |Escola Josep Barceló i Matas       |Departament d'Ensenyament |17200         |+34972300924  |+34972300924 |Palafrugell |Palafrugell |b7002491@xtec.cat |http://agora.xtec.cat/ceipbarceloimatas/          |c. Pals                       |75               |public        |1           |       3|      12|school; kindergarten |primary                 |\n|2022        |17002511 |Vedruna Palafrugell                |Fundacions                |17200         |+34972300739  |+34972300303 |Palafrugell |Palafrugell |b7002511@xtec.cat |http://WWW.vedrunapalafrugell.org                 |c. Sant Sebastià              |85               |private       |0; 1        |       0|      12|kindergarten; school |primary                 |\n|2022        |17002521 |Sant Jordi                         |Societats Mercantils      |17200         |+34972302898  |+34972304238 |Palafrugell |Palafrugell |b7002521@xtec.cat |http://www.escolasantjordi.cat                    |c. Tarongeta                  |65               |private       |1; 2        |       3|      16|school; kindergarten |primary; secondary      |\n|2022        |17002545 |Institut Frederic Martí i Carreras |Departament d'Ensenyament |17200         |+34972301079  |+34972611336 |Palafrugell |Palafrugell |b7002545@xtec.cat |http://agora.xtec.cat/iesfredericmarti/           |c. Frederic Martí Carreras    |13               |public        |2; 3        |      12|      18|school               |secondary               |\n|2022        |17002557 |Institut Baix Empordà              |Departament d'Ensenyament |17200         |+34972300323  |+34972611874 |Palafrugell |Palafrugell |b7002557@xtec.cat |http://www.insbaixemporda.cat                     |av. de les Corts Catalanes    |s/n              |public        |2; 3; 5     |      12|      NA|school               |secondary; professional |\n|2022        |17004876 |Escola l'Olivar Vell               |Departament d'Ensenyament |17255         |+34972611990  |+34972611990 |Begur       |Esclanyà    |b7004876@xtec.cat |https://agora.xtec.cat/ceipolivarvell/            |Veïnat Colomina               |s/n              |public        |1           |       3|      12|school; kindergarten |primary                 |\n|2022        |17006782 |Escola Carrilet                    |Departament d'Ensenyament |17200         |+34972306765  |+34972306770 |Palafrugell |Palafrugell |b7006782@xtec.cat |http://agora.xtec.cat/escolacarrilet/             |pl. Narcisa Oliver i Deulofeu |s/n              |public        |1           |       3|      12|school; kindergarten |primary                 |\n|2022        |17008523 |Escola Pi Verd                     |Departament d'Ensenyament |17200         |+34972610457  |+34NA        |Palafrugell |Palafrugell |b7008523@xtec.cat |http://agora.xtec.cat/escpiverd/                  |c. Vicenç Roure i Armadà      |12               |public        |1           |       3|      12|school; kindergarten |primary                 |\n:::\n:::\n\n\n\nTrobareu el codi per això i per altres coses d'OpenStreetMap al meu [GitHub](https://github.com/marcboschmatas/coses_openstreetmap)",
    "supporting": [
      "20221211_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}