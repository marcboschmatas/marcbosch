[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Marc Bosch i Matas",
    "section": "",
    "text": "Sóc politòleg una mica deformat cap a la geografia. M’agraden les ciutats, els mapes i les polítiques públiques. Era de lletres (crec que encara ho sóc en el fons) i he tirat cap als ordinadors."
  },
  {
    "objectID": "blog.html",
    "href": "blog.html",
    "title": "Blog",
    "section": "",
    "text": "OpenStreetMap\n\n\nOpenData\n\n\nDades Obertes\n\n\nR\n\n\n\n\n\n\n\n\n\n\n\nDec 23, 2022\n\n\nMarc Bosch Matas\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nOpenStreetMap\n\n\nOpenData\n\n\nDades Obertes\n\n\nR\n\n\n\n\n\n\n\n\n\n\n\nDec 11, 2022\n\n\nMarc Bosch Matas\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nR\n\n\nggplot2\n\n\ntidyverse\n\n\nTidyTuesday\n\n\n\n\n\n\n\n\n\n\n\nDec 2, 2022\n\n\nMarc Bosch\n\n\n\n\n\n\n  \n\n\n\n\n\n\n\n\n\n\nmapes\n\n\n30DayMapChallenge\n\n\nGIS\n\n\nR\n\n\n\n\n\n\n\n\n\n\n\nDec 2, 2022\n\n\nMarc Bosch\n\n\n\n\n\n\n  \n\n\n\n\n\n\n\n\n\n\ntidytuesday\n\n\nggplot\n\n\nmuseus\n\n\nR\n\n\n\n\n\n\n\n\n\n\n\nNov 23, 2022\n\n\nMarc Bosch\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "posts/post-with-code/index.html",
    "href": "posts/post-with-code/index.html",
    "title": "Post With Code",
    "section": "",
    "text": "1 + 1\n\n[1] 2"
  },
  {
    "objectID": "posts/welcome/index.html",
    "href": "posts/welcome/index.html",
    "title": "Welcome To My Blog",
    "section": "",
    "text": "Since this post doesn’t specify an explicit image, the first image in the post will be used in the listing page of posts."
  },
  {
    "objectID": "posts/new/20221123.html",
    "href": "posts/new/20221123.html",
    "title": "Tidy Tuesdays 23/11/2022",
    "section": "",
    "text": "El Tidy Tuesday és una iniciativa on cada setmana es penja un conjunt de dades a Github i tothom en pot fer una visualització. Avui va de museus.\n\n\nShow the code\n# libraries\n#| output: false\nlibrary(tidyverse)\nlibrary(tidytuesdayR)\nlibrary(knitr)\nlibrary(patchwork)\nlibrary(modthemes)\n# get data\ntt <- tidytuesdayR::tt_load(last_tuesday())[[1]]\n\n\n\n    Downloading file 1 of 1: `museums.csv`\n\n\nLa base de dades recull tot d’informació sobre els museus del Regne Unit: on són, quina mida tenen, de què van… Dedica diverses columnes a índexs de deprivació. Podem fer un retrat robot dels museus en cinc àrees segons índex de deprivació: molt baix, baix, mitjà, alt, molt alt.\n\n\nShow the code\ntt <- tt |> \n  filter(!is.na(Area_Deprivation_index)) |> \n  mutate(\"deprivation_index_quantiles\" = cut(Area_Deprivation_index,\n                                         breaks = c(-1,2,4,6,8,10),\n                                         labels = c(\"Molt alt\",\n                                                    \"Alt\",\n                                                    \"Mitjà\",\n                                                    \"Baix\",\n                                                    \"Molt baix\"))) \n\n\n\n\nShow the code\np1 <- ggplot(tt,\n             aes(x = deprivation_index_quantiles)) + \n  geom_bar(colour = \"black\",\n           fill = NA) + \n  theme_classic(base_family = \"Roboto condensed\") +\n  labs(title = \"Número de museus per àrea\") +\n  theme(axis.title.x = element_blank(),\n        axis.title.y = element_blank())\nproportions <- tt |> \n  mutate(\"titularitat\" = str_extract(Governance,\".*(?=\\\\-)\")) |> \n  group_by(deprivation_index_quantiles) |> \n  summarise(n = n())\np2 <- tt |> \n  mutate(titularitat = str_extract(Governance,\".*(?=\\\\-)\")) |> \n  group_by(titularitat, deprivation_index_quantiles) |> \n  summarise(n_td = n()) |> \n  ungroup() |> \n  left_join(proportions, by = \"deprivation_index_quantiles\") |> \n  mutate(prop = n_td/n,\n         titularitat = case_when(titularitat == \"Independent\" ~ \"Privada\",\n                                 titularitat == \"Government\" ~ \"Pública\",\n                                 is.na(titularitat) ~ \"Desconeguda\")) |> \n  ggplot(aes(x = deprivation_index_quantiles,\n             y = prop,\n             fill = titularitat)) + \n  geom_bar(stat = \"identity\",\n           position = \"dodge\") +\n  scale_y_continuous(labels = scales::label_percent()) + \n  scale_fill_manual(values = modthemes::contrasting_palette) + \n  labs(title = \"Titularitat dels museus per índex de deprivació\") +\n  theme_classic(base_family = \"Roboto condensed\") + \n  theme(axis.title.x = element_blank(),\n        axis.title.y = element_blank())\n\n  \np3 <- tt |> \n  mutate(\"mida_cat\" = factor(Size,\n                             levels = c(\"small\", \"medium\", \"large\", \"huge\", \"unknown\"),\n                             labels = c(\"petit\", \"mitjà\", \"gran\", \"molt gran\", \"NS\"))) |> \n  group_by(deprivation_index_quantiles, mida_cat) |> \n  summarise(n_dt = n()) |> \n  ungroup() |> \n  left_join(proportions, by = \"deprivation_index_quantiles\") |> \n  mutate(prop = n_dt/n) |> \n  ggplot(aes(x = deprivation_index_quantiles,\n             y = prop,\n             fill = mida_cat)) + \n  geom_bar(stat = \"identity\",\n           position = \"dodge\") +\n  scale_y_continuous(labels = scales::label_percent()) + \n  scale_fill_manual(values = modthemes::contrasting_palette) + \n  labs(title = \"Museus per mida i índex de deprivació\") +\n  theme_classic(base_family = \"Roboto condensed\") + \n  theme(axis.title.x = element_blank(),\n        axis.title.y = element_blank())\np1 + p2 + p3\n\n\n\n\n\nLes conclusions no són massa sorprenents. Les zones més deprimides tenen menys museus privats i petits, però també menys de molt grans. Seria interessant veure’n la qualitat però això serà un altre dia."
  },
  {
    "objectID": "posts/new/20221202.html",
    "href": "posts/new/20221202.html",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "",
    "text": "Aquest novembre he fet un mapa cada dia seguint la proposta del geògraf finès Topi Tjukanov. La idea era fer una mica de divulgació de coses que passen a Catalunya i Barcelona que es poden explicar en un mapa: he parlat de transport, verd, accessibilitat… I també he aprofitat per a seguir aprenent R. Si voleu veure tots els mapes i el codi, els trobareu aquí.\nAquí només vull ensenyar els mapes que més m’ha agradat fer o compartir."
  },
  {
    "objectID": "posts/new/20221202.html#viatges-dins-de-barcelona",
    "href": "posts/new/20221202.html#viatges-dins-de-barcelona",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "Viatges dins de Barcelona",
    "text": "Viatges dins de Barcelona\n\n\n\nDesplaçaments diaris\n\n\nAquest mapa ensenya cap a on anem un dia laborable. Fent servir les dades de l’INE, mesuro quanta gent surt del seu barri un dia laborable d’octubre de 2021 per estar-se més de quatre hores fora i cap on van. De cada barri surten tres línies cap als tres barris on més gent va i el color del barri representa quantes vegades surt al top-3 de destinacions de cada barri. Veiem per exemple que la Marina del Port té vuit fletxes, per tant, és al top tres de destinacions preferides al menys 8 vegades. Altres barris on va molta gent són la dreta de l’Eixample, La Bonanova i Montbau. En canvi, de l’extrem de Nou Barris, alguns barris de muntanya de Gràcia o Horta o de la Bordeta, Badal i Mercat Nou, la gent només en surt."
  },
  {
    "objectID": "posts/new/20221202.html#risc-dincendi-forestal",
    "href": "posts/new/20221202.html#risc-dincendi-forestal",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "Risc d’incendi forestal",
    "text": "Risc d’incendi forestal\n\n\n\nFreqüencies de risc alt\n\n\nAquest mapa no té cap secret, fa un recompte de quantes vegades cada comarca ha estat en risc alt o molt alt d’incendi forestal entre el 2000 i ara. M’agrada per això perquè les dades les vaig tenir gràcies a una petició de transparència que em van respondre els Agents Rurals molt ràpidament."
  },
  {
    "objectID": "posts/new/20221202.html#mercats-municipals",
    "href": "posts/new/20221202.html#mercats-municipals",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "Mercats municipals",
    "text": "Mercats municipals\n\n\n\nAccessibilitat als mercats\n\n\nLes distàncies a peu i el component espaial de l’equitat són un dels meus temes preferits. Veure qui i qui no té accés a les coses és una cosa que cal repetir molt sovint. Per això un mapa de mercats municipals on, afortunadament, estem prou bé. D’altra banda, m’agrada perquè va ser el primer mapa que vaig fer amb la paleta de colors inspirada en els mapes i gràfics de WEB DuBois."
  },
  {
    "objectID": "posts/new/20221202.html#freqüència-de-pas-per-parades-de-metro-i-autobús",
    "href": "posts/new/20221202.html#freqüència-de-pas-per-parades-de-metro-i-autobús",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "Freqüència de pas per parades de metro i autobús",
    "text": "Freqüència de pas per parades de metro i autobús\n\n\n\nFreqüències de pas\n\n\nLes animacions sempre són divertides. Es veu força clar quines línies de metro tenen més freqüència de pas que les altres."
  },
  {
    "objectID": "posts/new/20221202.html#prediccions-dús-del-sòl-a-les-illes-medes",
    "href": "posts/new/20221202.html#prediccions-dús-del-sòl-a-les-illes-medes",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "Prediccions d’ús del sòl a les Illes Medes",
    "text": "Prediccions d’ús del sòl a les Illes Medes\n\n\n\nUna mica d’aprenentatge automàtic\n\n\nFa temps que tinc ganes de posar-me amb l’anàlisi d’imatges aèries seriosament. Quan no hi ha dades dispoonibles, és una bona manera de veure on són les coses. Per això un petit experiment d’aprenentatge no supervisat amb imatges aèries de les Illes Medes. Li vaig demanar que m’agrupés tots els píxels en tres categories segons la combinació de verd, blau, vermell i infraroig proper i em va fer un mapa força realista!"
  },
  {
    "objectID": "posts/new/20221202.html#el-districte-veí-més-proper",
    "href": "posts/new/20221202.html#el-districte-veí-més-proper",
    "title": "#30DayMapChallenge: Conclusions",
    "section": "El districte veí més proper",
    "text": "El districte veí més proper\n\n\n\nBasat en una idea de Topi Tjukanov\n\n\nJa per acabar, un remake d’un mapa que vaig fer força temps. Quin és el districte veí més proper de qualsevol punt de Barcelona? Dit d’una altra manera, caminant en línia recta, en quina direcció he d’anar per canviar de districte el més ràpid possible?"
  },
  {
    "objectID": "posts/new/20221211.html",
    "href": "posts/new/20221211.html",
    "title": "Reutilitzant dades públiques: escoles a OpenStreetMap",
    "section": "",
    "text": "Fa no massa, vam obtenir permís per fer servir el Directori de Centres Educatius del Departament d’Educació. En aquest post, explicaré com agafem les dades i les preparem per a pujar-les a OpenStreetMap. Per exemple, amb el cas de Palafrugell. Així, el que farem serà el següent.\n\nBaixar totes les dades de centres educatius de Palafrugell que tenen un número de referència del departament d’Educació utilitzant l’API Overpass.\nBaixar les dades del Directori de Centres correspondent als centres que volem completar.\nTractar les dades i afegir les que falten a la taula d’OpenStreetMap.\nComprovar que tot estigui bé i pujar les dades fent servir l’editor JOSM.\n\n\n\nCodi R\nlibrary(sf) # tractar shapefiles\nlibrary(osmdata) # baixar data d'OSM\nlibrary(tmap) # fer mapes\nlibrary(tmaptools) # baixar mapa base\nlibrary(tidyverse) # tractar taules\nlibrary(httr) # baixar dades d'internet\nlibrary(jsonlite) # convertir JSONs a taules\nlibrary(rvest) # llegir webs\n\n\nComencem per baixar les dades d’OpenStreetMap i representar-les en un mapa.\n\n\nCodi R\nescoles <- opq(\"Palafrugell\") |> \n  add_osm_features(\"[\\\"amenity\\\"=\\\"school\\\"][\\\"ref\\\"]\") |> # this is a lot more cumbersome but allows to filter for missing tags\n  osmdata_sf()\n\nescoles_punts <- escoles$osm_points\nescoles_pol <- escoles$osm_polygons\nescoles_mpol <- escoles$osm_multipolygons\n\nescoles_osm <- escoles_pol |> \n  st_drop_geometry() |> \n  bind_rows(st_drop_geometry(escoles_mpol))\nknitr::kable(escoles_osm, style = \"pipe\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nosm_id\nname\naddr.city\naddr.housenumber\naddr.postcode\naddr.street\namenity\nleisure\nname.ca\nname.etymology.wikidata\noperator\nref\nreligion\nsport\nsurface\nwebsite\nwheelchair\nwikidata\nwikipedia\ntype\n\n\n\n\n167703123\n167703123\nEscola Josep Barceló i Matas\nNA\nNA\nNA\nNA\nschool\nNA\nNA\nQ19300295\nNA\n17002491\nNA\nNA\nNA\nNA\nNA\nQ111283965\nNA\nNA\n\n\n235507099\n235507099\nVedruna Palafrugell\nNA\nNA\nNA\nNA\nschool\nNA\nVedruna Palafrugell\nNA\nNA\n17002511\nNA\nNA\nNA\nNA\nNA\nQ111594946\nNA\nNA\n\n\n367243676\n367243676\nEscola Carrilet\nNA\nNA\nNA\nNA\nschool\nNA\nEscola Carrilet\nNA\nAjuntament de Palafrugell\n17006782\nNA\nNA\nNA\nNA\nyes\nQ111283756\nNA\nNA\n\n\n367352591\n367352591\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n367693485\n367693485\nNA\nNA\nNA\nNA\nNA\nNA\npitch\nNA\nNA\nNA\nNA\nNA\nsoccer\nconcrete\nNA\nNA\nNA\nNA\nNA\n\n\n367714709\n367714709\nInstitut Baix Empordà\nNA\nNA\nNA\nNA\nschool\nNA\nNA\nNA\nGeneralitat de Catalunya\n17002557\nNA\nNA\nNA\nNA\nyes\nQ11926287\nNA\nNA\n\n\n367729357\n367729357\nEscola Sant Jordi\nNA\nNA\nNA\nNA\nschool\nNA\nEscola Sant Jordi\nNA\nNA\n17002521\nNA\nNA\nNA\nNA\nNA\nQ111594947\nNA\nNA\n\n\n368163468\n368163468\nEscola Torres Jonama\nNA\nNA\nNA\nNA\nschool\nNA\nEscola Torres Jonama\nNA\nGeneralitat de Catalunya\n17002481\nNA\nNA\nNA\nNA\nyes\nQ11910302\nca:CEIP Torres Jonama\nNA\n\n\n816953410\n816953410\nEscola l’Olivar Vell\nEsclanyà\nNA\nNA\nNA\nschool\nNA\nEscola l’Olivar Vell\nNA\nNA\n17004876\nNA\nNA\nNA\nNA\nNA\nQ111283738\nNA\nNA\n\n\n1015010006\n1015010006\nEscola Pi Verd\nPalafrugell\n12\n17200\nCarrer de Viçens Roure i Armadà\nschool\nNA\nEscola Pi Verd\nNA\nNA\n17008523\nchristian\nNA\nNA\nhttps://agora.xtec.cat/escpiverd/\nNA\nQ111283815\nNA\nNA\n\n\n5465679\n5465679\nInstitut Frederic Martí i Carreras\nNA\nNA\nNA\nNA\nschool\nNA\nNA\nQ11923061\nGeneralitat de Catalunya\n17002545\nNA\nNA\nNA\nNA\nyes\nQ111253680\nNA\nmultipolygon\n\n\n\n\n\n\n\nCodi R\nbm <- read_osm(escoles_punts)\n\ntm_shape(bm) + \n  tm_rgb() + \n  tm_shape(escoles_pol) + \n  tm_borders(col = modthemes::dubois_blue,\n             lwd = 2) + \n  tm_shape(escoles_mpol) + \n  tm_borders(col = modthemes::dubois_blue,\n             lwd = 2)\n\n\n\n\n\n\n\n\n\nVeiem que ens surten alguns objectes sense codi de referència, però no ens hauria de preocupar massa. Són objectes com patis o pistes poliesportives que formen part de les relacions (és a dir, col·leccions d’objectes) de les escoles. Ara toca baixar-nos les dades del Departament d’Educació. Ho fem amb les llibreries httr i jsonlite que ens permeten crear una URL on hi hagi les dades de tots els centres que ens interessen, baixar-nos la informació i organitzar-la en forma de taula.\n\n\nCodi R\n# crear vector de codis únics\nrefs <- unique(c(escoles_pol$ref, escoles_mpol$ref))\nrefs <- refs[!is.na(refs)]\n# crear una variable character amb tots els codis separats per codis\nreftext <- sapply(refs, \\(x) paste0(\"'\",str_pad(x, width=8, pad = 0),\"'\")) |> \n  paste(collapse = \", \")\n\n# generar una url de l'API de dades obertes de la Generalitat que ens\nbaseurl <- \"https://analisi.transparenciacatalunya.cat/resource/kvmv-ahh4.json?$query=\"\n\n\nquery = paste0(\"SELECT * WHERE codi_centre IN (\", reftext, \") AND curs='2022/2023'\")\nquery <- str_replace_all(query,\" \",\"%20\")\n\n# descarregar les dades i passar-les a format taula\nescoles_gene <- GET(paste0(baseurl,query)) |> \n  content(as = \"text\") |> \n  fromJSON()\n\nknitr::kable(escoles_gene, style = \"pipe\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ncurs\nany\ncodi_centre\ndenominaci_completa\ncodi_naturalesa\nnom_naturalesa\ncodi_titularitat\nnom_titularitat\nadre_a\ncodi_postal\ntel_fon\nfax\ncodi_delegaci\nnom_delegaci\ncodi_comarca\nnom_comarca\ncodi_municipi\ncodi_municipi_6\nnom_municipi\ncodi_districte_municipal\ncodi_localitat\nnom_localitat\nzona_educativa\ncoordenades_utm_x\ncoordenades_utm_y\ncoordenades_geo_x\ncoordenades_geo_y\ne_mail_centre\nurl\neinf2c\nepri\neinf1c\neso\nbatx\ncfpm\naa03\ncfps\npfi\n\n\n\n\n2022/2023\n2022\n17002481\nEscola Torres Jonama\n1\nPúblic\n01\nDepartament d’Ensenyament\nc. Escoles, 10\n17200\n972610882\n972610652\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n513844\n4640216\n3.166934\n41.913774\nb7002481@xtec.cat\nhttp://www.xtec.cat/ceiptorresjonama-palafrugell/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17002491\nEscola Josep Barceló i Matas\n1\nPúblic\n01\nDepartament d’Ensenyament\nc. Pals, 75\n17200\n972300924\n972300924\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n513374\n4640994\n3.16129\n41.920784\nb7002491@xtec.cat\nhttp://agora.xtec.cat/ceipbarceloimatas/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17002511\nVedruna Palafrugell\n2\nPrivat\n22\nFundacions\nc. Sant Sebastià, 85\n17200\n972300739\n972300303\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n514063\n4640552\n3.169588\n41.916794\nb7002511@xtec.cat\nhttp://WWW.vedrunapalafrugell.org\nEINF2C\nEPRI\nEINF1C\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17002521\nSant Jordi\n2\nPrivat\n26\nSocietats Mercantils\nc. Tarongeta, 65\n17200\n972302898\n972304238\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n513935\n4640611\n3.168046\n41.91733\nb7002521@xtec.cat\nhttp://www.escolasantjordi.cat\nEINF2C\nEPRI\nNA\nESO\nNA\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17002545\nInstitut Frederic Martí i Carreras\n1\nPúblic\n01\nDepartament d’Ensenyament\nc. Frederic Martí Carreras, 13\n17200\n972301079\n972611336\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n513680\n4639998\n3.164958\n41.911812\nb7002545@xtec.cat\nhttp://agora.xtec.cat/iesfredericmarti/\nNA\nNA\nNA\nESO\nBATX\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17002557\nInstitut Baix Empordà\n1\nPúblic\n01\nDepartament d’Ensenyament\nav. de les Corts Catalanes, s/n\n17200\n972300323\n972611874\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n513786\n4639842\n3.166224\n41.910404\nb7002557@xtec.cat\nhttp://www.insbaixemporda.cat\nNA\nNA\nNA\nESO\nBATX\nCFPM\nAA03\nCFPS\nPFI\n\n\n2022/2023\n2022\n17004876\nEscola l’Olivar Vell\n1\nPúblic\n01\nDepartament d’Ensenyament\nVeïnat Colomina, s/n\n17255\n972611990\n972611990\n0117\nGirona\n10\nBaix Empordà\n17013\n170139\nBegur\n00\n02\nEsclanyà\nBaix Empordà\n514364\n4642168\n3.173253\n41.931346\nb7004876@xtec.cat\nhttps://agora.xtec.cat/ceipolivarvell/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17006782\nEscola Carrilet\n1\nPúblic\n01\nDepartament d’Ensenyament\npl. Narcisa Oliver i Deulofeu, s/n\n17200\n972306765\n972306770\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n512884\n4639998\n3.155351\n41.911822\nb7006782@xtec.cat\nhttp://agora.xtec.cat/escolacarrilet/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n2022/2023\n2022\n17008523\nEscola Pi Verd\n1\nPúblic\n01\nDepartament d’Ensenyament\nc. Vicenç Roure i Armadà, 12\n17200\n972610457\nNA\n0117\nGirona\n10\nBaix Empordà\n17117\n171175\nPalafrugell\n00\n06\nPalafrugell\nBaix Empordà\n514349\n4640814\n3.173042\n41.919148\nb7008523@xtec.cat\nhttp://agora.xtec.cat/escpiverd/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\n\n\n\n\n\nTenim un munt de variables, moltes de les quals ens interessen. Algunes les podem incorporar tal i com van i d’altres voldran una mica de feina. Comencem per l’adreça. Veiem que hi ha quatre camps vinculats amb l’adreça: addr.city, addr.housenumber (número d’edifici), addr.postcode (codi postal) i addr.street (carrer). D’altra banda, podem agafar directament la web, el correu electrònic i com el nom del titular. La titularitat també es pot agafar directament, però cal traduir-ho a l’anglès. També cal afegir els prefixos internacionals als camps de telèfon i fax.\n\n\nCodi R\nescoles_gene_osm <- escoles_gene |> \n  select(-c(curs, codi_titularitat, codi_naturalesa, \n            codi_delegaci, nom_delegaci, codi_comarca,\n            codi_municipi, codi_municipi_6, \n            codi_localitat, codi_districte_municipal, \n            nom_comarca, zona_educativa,\n            coordenades_utm_x, coordenades_utm_y,\n            coordenades_geo_x, coordenades_geo_y)) |> # eliminar columnes que no calen\n  rename(\"operator\" = \"nom_titularitat\",\n         \"name\" = \"denominaci_completa\",\n         \"ref\" = \"codi_centre\",\n         \"contact:phone\" = \"tel_fon\",\n         \"contact:fax\" = \"fax\",\n         \"contact:email\" = \"e_mail_centre\",\n         \"website\" = \"url\",\n         \"addr:city\" = \"nom_municipi\",\n         \"addr:place\" = \"nom_localitat\",\n         \"addr:postcode\" = \"codi_postal\",\n         \"source:date\" = \"any\") |> # canviar noms de columnes que podem adaptar \"tal qual\"\n  mutate(\"contact:fax\" = paste0(\"+34\",`contact:fax`),\n         \"contact:phone\" = paste0(\"+34\", `contact:phone`),\n         \"addr:street\" = str_extract(adre_a, \"^[^\\\\,]+\"),\n         \"addr:housenumber\" = str_extract(adre_a, \"[^\\\\, ]+$\"),\n         \"operator:type\" = ifelse(nom_naturalesa == \"Públic\", \"public\", \"private\"))\nknitr::kable(escoles_gene_osm, style = \"pipe\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nsource:date\nref\nname\nnom_naturalesa\noperator\nadre_a\naddr:postcode\ncontact:phone\ncontact:fax\naddr:city\naddr:place\ncontact:email\nwebsite\neinf2c\nepri\neinf1c\neso\nbatx\ncfpm\naa03\ncfps\npfi\naddr:street\naddr:housenumber\noperator:type\n\n\n\n\n2022\n17002481\nEscola Torres Jonama\nPúblic\nDepartament d’Ensenyament\nc. Escoles, 10\n17200\n+34972610882\n+34972610652\nPalafrugell\nPalafrugell\nb7002481@xtec.cat\nhttp://www.xtec.cat/ceiptorresjonama-palafrugell/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nc. Escoles\n10\npublic\n\n\n2022\n17002491\nEscola Josep Barceló i Matas\nPúblic\nDepartament d’Ensenyament\nc. Pals, 75\n17200\n+34972300924\n+34972300924\nPalafrugell\nPalafrugell\nb7002491@xtec.cat\nhttp://agora.xtec.cat/ceipbarceloimatas/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nc. Pals\n75\npublic\n\n\n2022\n17002511\nVedruna Palafrugell\nPrivat\nFundacions\nc. Sant Sebastià, 85\n17200\n+34972300739\n+34972300303\nPalafrugell\nPalafrugell\nb7002511@xtec.cat\nhttp://WWW.vedrunapalafrugell.org\nEINF2C\nEPRI\nEINF1C\nNA\nNA\nNA\nNA\nNA\nNA\nc. Sant Sebastià\n85\nprivate\n\n\n2022\n17002521\nSant Jordi\nPrivat\nSocietats Mercantils\nc. Tarongeta, 65\n17200\n+34972302898\n+34972304238\nPalafrugell\nPalafrugell\nb7002521@xtec.cat\nhttp://www.escolasantjordi.cat\nEINF2C\nEPRI\nNA\nESO\nNA\nNA\nNA\nNA\nNA\nc. Tarongeta\n65\nprivate\n\n\n2022\n17002545\nInstitut Frederic Martí i Carreras\nPúblic\nDepartament d’Ensenyament\nc. Frederic Martí Carreras, 13\n17200\n+34972301079\n+34972611336\nPalafrugell\nPalafrugell\nb7002545@xtec.cat\nhttp://agora.xtec.cat/iesfredericmarti/\nNA\nNA\nNA\nESO\nBATX\nNA\nNA\nNA\nNA\nc. Frederic Martí Carreras\n13\npublic\n\n\n2022\n17002557\nInstitut Baix Empordà\nPúblic\nDepartament d’Ensenyament\nav. de les Corts Catalanes, s/n\n17200\n+34972300323\n+34972611874\nPalafrugell\nPalafrugell\nb7002557@xtec.cat\nhttp://www.insbaixemporda.cat\nNA\nNA\nNA\nESO\nBATX\nCFPM\nAA03\nCFPS\nPFI\nav. de les Corts Catalanes\ns/n\npublic\n\n\n2022\n17004876\nEscola l’Olivar Vell\nPúblic\nDepartament d’Ensenyament\nVeïnat Colomina, s/n\n17255\n+34972611990\n+34972611990\nBegur\nEsclanyà\nb7004876@xtec.cat\nhttps://agora.xtec.cat/ceipolivarvell/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nVeïnat Colomina\ns/n\npublic\n\n\n2022\n17006782\nEscola Carrilet\nPúblic\nDepartament d’Ensenyament\npl. Narcisa Oliver i Deulofeu, s/n\n17200\n+34972306765\n+34972306770\nPalafrugell\nPalafrugell\nb7006782@xtec.cat\nhttp://agora.xtec.cat/escolacarrilet/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\npl. Narcisa Oliver i Deulofeu\ns/n\npublic\n\n\n2022\n17008523\nEscola Pi Verd\nPúblic\nDepartament d’Ensenyament\nc. Vicenç Roure i Armadà, 12\n17200\n+34972610457\n+34NA\nPalafrugell\nPalafrugell\nb7008523@xtec.cat\nhttp://agora.xtec.cat/escpiverd/\nEINF2C\nEPRI\nNA\nNA\nNA\nNA\nNA\nNA\nNA\nc. Vicenç Roure i Armadà\n12\npublic\n\n\n\n\n\nVeureu per això, que he deixat unes quantes columnes sense tractar, que tenen a veure amb quins cicles imparteixen. A partir d’això, cal generar tres variables més. isced:level, que estandarditza els nivells d’educació a nivell mundial (podeu veure’n totes les equivalències aquí), min_age (edat mínima), max_age (edat màxima), school el tipus d’escola i amenity on distingim entre escoles bressol, escoles de música elementals, d’idiomes o escoles de qualsevol altre tipus. Primer de tot, copiem la taula d’equivalències de la wiki d’OpenStreetMap.\n\n\nCodi R\neqs <- \"https://wiki.openstreetmap.org/wiki/Import_schools_in_Catalunya\" |> \n  read_html() |> \n  html_nodes(xpath = '/html/body/div[3]/div[3]/div[5]/div[1]/table[2]') |> \n  html_table()\neqs <- eqs[[1]] |> \n  mutate(Cycle = str_split(Cycle, \", \")) |> \n  unnest(cols = Cycle) |> \n  mutate(Cycle = str_to_lower(Cycle))\nknitr::kable(eqs, style = \"pipe\")\n\n\n\n\n\nCycle\nISCED level\nmin_age\nmax_age\n\n\n\n\neinf1c\n0\n0\n3\n\n\neinf2c\n1\n3\n6\n\n\nepri\n1\n6\n12\n\n\neso\n2\n12\n16\n\n\nbatx\n3\n16\n18\n\n\naa01\n2\nNA\nNA\n\n\ncfpm\n3\n16\nNA\n\n\ncfam\n3\n16\nNA\n\n\ntegm\n3\n16\nNA\n\n\npa01\n3\n16\nNA\n\n\nppas\n3\n16\nNA\n\n\naa03\n3\n16\nNA\n\n\ncfps\n5\n18\nNA\n\n\ncfas\n5\n18\nNA\n\n\nesdi\n5\n18\nNA\n\n\ndans\n5\n18\nNA\n\n\nmuss\n5\n18\nNA\n\n\ntegs\n5\n18\nNA\n\n\npa02\n5\n18\nNA\n\n\nadr\n5\n18\nNA\n\n\ncrbc\n5\n18\nNA\n\n\npfi\n2\n16\n21\n\n\ndane\n1; 2\nNA\nNA\n\n\nmuse\n1; 2\nNA\nNA\n\n\ndanp\n2; 3\n12\n18\n\n\nmusp\n2; 3\n12\n18\n\n\nestr\n\nNA\nNA\n\n\nidi\n\n16\nNA\n\n\nadults\n1; 2; 3\n18\nNA\n\n\nee\n1; 2\n3\nNA\n\n\n\n\n\nAra ja podem generar les columnes que falten.\n\n\nCodi R\nescoles_gene_isced <- escoles_gene |> \n  select(\"codi_centre\", \"epri\", \"einf1c\", \"einf2c\", \"eso\", \"batx\", \"cfpm\", \"aa03\", \"cfps\", \"pfi\") |> \n  pivot_longer(-codi_centre,\n               names_to = \"level_name\",\n               values_to = \"junk\") |> \n  filter(!is.na(junk)) |> \n  select(-junk) |> \n  left_join(eqs, by = c(\"level_name\" = \"Cycle\")) |> \n  mutate(\"school\" = case_when(level_name %in% c(\"einf1c\", \"einf2c\") ~ NA_character_,\n                              level_name == \"epri\" ~ \"primary\",\n                              level_name %in% c(\"eso\", \"batx\") ~ \"secondary\",\n                              level_name %in% c(\"aa01\", \"cfpm\", \"ppas\", \n                                                \"aa03\", \"cfps\", \"pfi\", \"pa01\",\n                                                \"cfam\", \"pa02\", \"cfas\",\n                                                \"esdi\", \"adr\", \"crbc\",\n                                                \"dans\", \"musp\", \"muss\",\n                                                \"tegm\", \"tegs\") ~ \"professional\",\n                              level_name == \"ee\" ~ \"special_education_needs\",\n                              TRUE ~ NA_character_),\n         \"amenity\" = case_when(level_name %in% c(\"einf1c\", \"einf2c\") ~ \"kindergarten\",\n                               level_name == \"muse\" ~ \"music_school\",\n                               level_name == \"dane\" ~ NA_character_,\n                               level_name == \"idi\" ~ \"language_school\",\n                               TRUE ~ \"school\")) |> \n  arrange(`ISCED level`) |> \n  group_by(codi_centre) |> \n  summarise(\"isced:level\" = paste(unique(`ISCED level`), collapse = \"; \"),\n            \"min_age\" = min(min_age),\n            \"max_age\" = ifelse(length(c(max_age)[is.na(c(max_age))]) > 0, NA_integer_,max(max_age)),\n            \"amenity\" = paste(unique(`amenity`), collapse = \"; \"),\n            \"school\" = paste(unique(school)[!is.na(c(unique(school)))], collapse = \"; \"))\nknitr::kable(escoles_gene_isced, style = \"pipe\")\n\n\n\n\n\n\n\n\n\n\n\n\n\ncodi_centre\nisced:level\nmin_age\nmax_age\namenity\nschool\n\n\n\n\n17002481\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n17002491\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n17002511\n0; 1\n0\n12\nkindergarten; school\nprimary\n\n\n17002521\n1; 2\n3\n16\nschool; kindergarten\nprimary; secondary\n\n\n17002545\n2; 3\n12\n18\nschool\nsecondary\n\n\n17002557\n2; 3; 5\n12\nNA\nschool\nsecondary; professional\n\n\n17004876\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n17006782\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n17008523\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n\n\n\nAra només queda generar una taula única i ja tenim totes les dades preparades per a importar-les a OpenStreetMap amb JOSM o qualsevol altra eina.\n\n\nCodi R\nescoles_gene_osm <- escoles_gene_osm |> \n  select(-c(\"epri\", \"einf1c\", \"einf2c\", \"eso\", \"batx\", \"cfpm\", \"aa03\", \"cfps\", \"pfi\", \"nom_naturalesa\", \"adre_a\")) |> \n  left_join(escoles_gene_isced, by = c(\"ref\" = \"codi_centre\"))\nknitr::kable(escoles_gene_osm, style = \"pipe\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nsource:date\nref\nname\noperator\naddr:postcode\ncontact:phone\ncontact:fax\naddr:city\naddr:place\ncontact:email\nwebsite\naddr:street\naddr:housenumber\noperator:type\nisced:level\nmin_age\nmax_age\namenity\nschool\n\n\n\n\n2022\n17002481\nEscola Torres Jonama\nDepartament d’Ensenyament\n17200\n+34972610882\n+34972610652\nPalafrugell\nPalafrugell\nb7002481@xtec.cat\nhttp://www.xtec.cat/ceiptorresjonama-palafrugell/\nc. Escoles\n10\npublic\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n2022\n17002491\nEscola Josep Barceló i Matas\nDepartament d’Ensenyament\n17200\n+34972300924\n+34972300924\nPalafrugell\nPalafrugell\nb7002491@xtec.cat\nhttp://agora.xtec.cat/ceipbarceloimatas/\nc. Pals\n75\npublic\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n2022\n17002511\nVedruna Palafrugell\nFundacions\n17200\n+34972300739\n+34972300303\nPalafrugell\nPalafrugell\nb7002511@xtec.cat\nhttp://WWW.vedrunapalafrugell.org\nc. Sant Sebastià\n85\nprivate\n0; 1\n0\n12\nkindergarten; school\nprimary\n\n\n2022\n17002521\nSant Jordi\nSocietats Mercantils\n17200\n+34972302898\n+34972304238\nPalafrugell\nPalafrugell\nb7002521@xtec.cat\nhttp://www.escolasantjordi.cat\nc. Tarongeta\n65\nprivate\n1; 2\n3\n16\nschool; kindergarten\nprimary; secondary\n\n\n2022\n17002545\nInstitut Frederic Martí i Carreras\nDepartament d’Ensenyament\n17200\n+34972301079\n+34972611336\nPalafrugell\nPalafrugell\nb7002545@xtec.cat\nhttp://agora.xtec.cat/iesfredericmarti/\nc. Frederic Martí Carreras\n13\npublic\n2; 3\n12\n18\nschool\nsecondary\n\n\n2022\n17002557\nInstitut Baix Empordà\nDepartament d’Ensenyament\n17200\n+34972300323\n+34972611874\nPalafrugell\nPalafrugell\nb7002557@xtec.cat\nhttp://www.insbaixemporda.cat\nav. de les Corts Catalanes\ns/n\npublic\n2; 3; 5\n12\nNA\nschool\nsecondary; professional\n\n\n2022\n17004876\nEscola l’Olivar Vell\nDepartament d’Ensenyament\n17255\n+34972611990\n+34972611990\nBegur\nEsclanyà\nb7004876@xtec.cat\nhttps://agora.xtec.cat/ceipolivarvell/\nVeïnat Colomina\ns/n\npublic\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n2022\n17006782\nEscola Carrilet\nDepartament d’Ensenyament\n17200\n+34972306765\n+34972306770\nPalafrugell\nPalafrugell\nb7006782@xtec.cat\nhttp://agora.xtec.cat/escolacarrilet/\npl. Narcisa Oliver i Deulofeu\ns/n\npublic\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n2022\n17008523\nEscola Pi Verd\nDepartament d’Ensenyament\n17200\n+34972610457\n+34NA\nPalafrugell\nPalafrugell\nb7008523@xtec.cat\nhttp://agora.xtec.cat/escpiverd/\nc. Vicenç Roure i Armadà\n12\npublic\n1\n3\n12\nschool; kindergarten\nprimary\n\n\n\n\n\nTrobareu el codi per això i per altres coses d’OpenStreetMap al meu GitHub"
  },
  {
    "objectID": "posts/new/20221223.html",
    "href": "posts/new/20221223.html",
    "title": "Lloguers i renda per barris",
    "section": "",
    "text": "Codi R\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(ggthemes)\nlibrary(patchwork)\npath <- \"/home/marc/Documents/trimestral_bcn_lloguer.xlsx\"\nlloguer_2022 <- read_xlsx(path = path,\n                          sheet = \"2022\",\n                          range = \"B22:E94\",\n                          na = \"nd\",\n                          col_names = c(\"barri\", \"2022/01/01\",\"2022/04/01\",\n                                        \"2022/07/01\"))\nlloguer_2021 <- read_xlsx(path = path,\n                          sheet = \"2021\",\n                          range = \"B22:F94\",\n                          na = c(\"nd\",\"0\"),\n                          col_names = c(\"barri\", \"2021/01/01\",\n                                        \"2021/04/01\", \"2021/07/01\", \n                                        \"2021/10/01\"))\n\nlloguer_2020 <- read_xlsx(path = path,\n                          sheet = \"2020\",\n                          range = \"B22:F94\",\n                          na = c(\"nd\",\"0\"),\n                          col_names = c(\"barri\", \"2020/01/01\",\n                                        \"2020/04/01\", \"2020/07/01\", \n                                        \"2020/10/01\"))\nlloguer_2019 <- read_xlsx(path = path,\n                          sheet = \"2019\",\n                          range = \"B22:F94\",\n                          na = c(\"nd\",\"0\", \"\"),\n                          col_names = c(\"barri\", \"2019/01/01\",\n                                        \"2019/04/01\", \"2019/07/01\", \n                                        \"2019/10/01\"))\nlloguer_2018 <- read_xlsx(path = path,\n                          sheet = \"2018\",\n                          range = \"B22:F94\",\n                          na = c(\"nd\",\"0\", \"\"),\n                          col_names = c(\"barri\", \"2018/01/01\",\n                                        \"2018/04/01\", \"2018/07/01\", \n                                        \"2018/10/01\"))\nlloguer_2017 <- read_xlsx(path = path,\n                          sheet = \"2017\",\n                          range = \"B22:F94\",\n                          na = c(\"nd\",\"0\", \"\"),\n                          col_names = c(\"barri\", \"2017/01/01\",\n                                        \"2017/04/01\", \"2017/07/01\", \n                                        \"2017/10/01\"))\n\nlloguer_2016 <- read_xlsx(path = path,\n                          sheet = \"2016\",\n                          range = \"B22:F94\",\n                          na = c(\"nd\",\"0\", \"\", \"n.d.\"),\n                          col_names = c(\"barri\", \"2016/01/01\",\n                                        \"2016/04/01\", \"2016/07/01\", \n                                        \"2016/10/01\"))\nlloguer_2015 <- read_xlsx(path = path,\n                          sheet = \"2015\",\n                          range = \"B21:F93\",\n                          na = c(\"nd\",\"0\", \"\", \"n.d.\"),\n                          col_names = c(\"barri\", \"2015/01/01\",\n                                        \"2015/04/01\", \"2015/07/01\", \n                                        \"2015/10/01\"))\nlloguer_2014 <- read_xlsx(path = path,\n                          sheet = \"2014\",\n                          range = \"B21:F93\",\n                          na = c(\"nd\",\"0\", \"\", \"n.d.\"),\n                          col_names = c(\"barri\", \"2014/01/01\",\n                                        \"2014/04/01\", \"2014/07/01\", \n                                        \"2014/10/01\"))\n\nrenda_barris <- read_csv(\"https://opendata-ajuntament.barcelona.cat/data/dataset/c9b9b5e5-b02f-4b47-892b-79acf0191802/resource/0d9df8cf-8b95-43c3-b07d-14e11f2ebdaf/download/2019_renda_neta_mitjana_per_llar.csv\")\n\n\nPrimer de tot, com s’ha comportat el lloguer mitjà a cada barri des del principi de 2014 fins a finals de setembre de 2022?\n\n\nCodi R\nlloguer_total <- lloguer_2014 |>  \n  left_join(lloguer_2015, by = \"barri\") |> \n  left_join(lloguer_2016, by = \"barri\") |> \n  left_join(lloguer_2017, by = \"barri\") |> \n  left_join(lloguer_2018, by = \"barri\") |> \n  left_join(lloguer_2019, by = \"barri\") |> \n  left_join(lloguer_2020, by = \"barri\") |> \n  left_join(lloguer_2021, by = \"barri\") |> \n  left_join(lloguer_2022, by = \"barri\")\nlloguer_total$count_na <- rowSums(is.na(lloguer_total))\n\ndifs <- lloguer_total |>\n  filter(count_na == 0) |> \n  rowwise() |> \n  mutate(dif = `2022/01/01`-`2014/01/01`) |> \n  select(barri, dif)\n# eliminate sections w too many na\n\nlloguer_total_long <- lloguer_total |>  \n  filter(count_na == 0) |> \n  select(-count_na) |> \n  pivot_longer(-barri, names_to = \"trimestre\", values_to = \"lloguer\") |> \n  mutate(trimestre = as.Date(trimestre)) |> \n  left_join(difs, by = \"barri\") |> \n  mutate(barri = factor(barri),\n         barri = fct_reorder(barri,dif))\n\nbegs <- lloguer_total_long |> \n  group_by(barri) |> \n  filter(trimestre == \"2014/01/01\")\n\nends <- lloguer_total_long |> \n  group_by(barri) |> \n  filter(trimestre == \"2022/07/01\")\n\nggplot(lloguer_total_long, aes(x = trimestre, y = lloguer)) + \n  geom_line() + \n  geom_point(data = begs,\n             colour = modthemes::dubois_green) + \n  geom_point(data = ends,\n             colour = modthemes::dubois_red) + \n  geom_text(data = begs, mapping = aes(label = round(lloguer,0)), \n            nudge_x = -300, size = 3.5) + \n  geom_text(data = ends, mapping = aes(label = round(lloguer,0)), \n            nudge_x = 300, size = 3.5) + \n    scale_y_continuous(expand = c(1, 0)) +\n  facet_grid(barri ~ ., scales = \"free_y\") +\n  ggthemes::theme_tufte(base_family = \"Montserrat\") + \n  theme(axis.title=element_blank(), \n        axis.text.y = element_blank(),\n        strip.text.y = element_text(angle = 0), # etiquetes horitzontals\n        text = element_text(family = \"Montserrat\"),\n        axis.ticks.y = element_blank()) \n\n\n\n\n\nEvolució del lloguer per barris 2014-2022. S’han eliminat els barris amb valors perduts.\n\n\n\n\nVeiem que no hi ha cap barri que es salvi de pujades importants, tot i que no tots ho han fet al mateix ritme. Vegem-ho ara en relació de la renda mitjana per llar de cada barri: quin percentatge de la renda mitjana suposa el lloguer mitjà? I quin percentatge suposa l’increment en euros del lloguer entre el tercer trimestre de 2021 i la mateixa data de 2022?\n\n\nCodi R\nrenda_barris_group <- renda_barris |> \n  mutate(Nom_Barri = case_when(Nom_Barri == \"el Gòtic\" ~ \"el Barri Gòtic\",\n                               Nom_Barri == \"el Poble Sec\" ~ \"el Poble Sec - AEI Parc Montjuïc\",\n                               Nom_Barri == \"la Marina del Prat Vermell\" ~ \"la Marina del Prat Vermell - AEI Zona Franca\",\n                               Nom_Barri == \"el Putget i Farró\" ~ \"el Putxet i el Farró\",\n                               Nom_Barri == \"Vila de Gràcia\" ~ \"la Vila de Gràcia\",\n                               Nom_Barri == \"Camp de l'Arpa del Clot\" ~ \"el Camp de l'Arpa del Clot\",\n                               TRUE ~ Nom_Barri)) |> \n  group_by(Nom_Barri) |> \n  summarise(renda = mean(Import_Euros, na.rm = TRUE))\nlloguer_2221 <- lloguer_total |> \n  select(barri, \"2022/07/01\", \"2021/07/01\") |> \n  rowwise() |> \n  mutate(dif = `2022/07/01`-`2021/07/01`) |> \n  select(-`2021/07/01`) |> \n  left_join(renda_barris_group, by = c(\"barri\" = \"Nom_Barri\")) |> \n  mutate(\"lloguer\" = `2022/07/01`/renda,\n         \"creixement\" = dif/renda) |> \n  select(barri, lloguer, creixement) |> \n  filter(!is.na(creixement))\n\n\nggplot(lloguer_2221, aes(y = reorder(barri, lloguer), x = lloguer)) + \n  geom_bar(stat = \"identity\",\n           fill = \"white\",\n           colour = \"black\") + \n  geom_text(aes(label = round(lloguer,2)), nudge_y = 0.02) + \n  ggthemes::theme_tufte(base_family = \"Montserrat\") + \n  theme(axis.title = element_blank(),\n        text = element_text(family = \"Montserrat\"))\n\n\n\n\n\nLloguer mitjà per barri al tercer trimestre de 2022 en relació a la renda mitjana del barri. La renda del barri es calcula com la mitjana entre les rendes de cada secció censal i correspon al darrer valor disponible al portal de dades de l’Ajuntament de Barcelona (2019)\n\n\n\n\n\n\nCodi R\nggplot(lloguer_2221, aes(y = reorder(barri, creixement), x = creixement)) + \n  geom_bar(stat = \"identity\",\n           fill = \"white\",\n           colour = \"black\") + \n    geom_text(aes(label = round(creixement,4)), nudge_y = 0.002) +\n  ggthemes::theme_tufte(base_family = \"Montserrat\") + \n  theme(axis.title = element_blank())\n\n\n\n\n\nIncrement del lloguer mitjà per barri entre el tercer trimestre de 2021 i la mateixa data de 2022 en relació a la renda mitjana del barri. La renda del barri es calcula com la mitjana entre les rendes de cada secció censal i correspon al darrer valor disponible al portal de dades de l’Ajuntament de Barcelona (2019)\n\n\n\n\nCap sorpresa. El lloguer suposa un percentatge més elevat de la renda per llar a Ciutat Vella (pressió turística), algunes zones del POblenou, Sants-Montjuic, Gràcia i Eixample. Pel que fa a l’increment del lloguer, no veiem un patró clar, malgrat que els increments han estat menors respecte a la renda per llar en zones de rendes baixes (amb excepcions com Pedralbes) i a les zones on suposen increments més elevats, veiem llocs tant diferents com Sant Martí de Provençals, la Bordeta o Vallvidrera, el Tibidabo i Les Planes."
  },
  {
    "objectID": "posts/new/20230103.html",
    "href": "posts/new/20230103.html",
    "title": "#TidyTuesday Creant un objecte ggplot",
    "section": "",
    "text": "Els indicadors que formen l’índex de RFD són: (1) La taxa de persones amb titulació superior; (2) La taxa d’atur; (3) El nombre de turismes per 1.000 habitants; (4) El percentatge de turismes nous d’elevada potència sobre el total de turismes nous; (5) El preu dels habitatges de segona mà.\n\n\nShow the code\nlibrary(tidyverse)\nlibrary(ggthemes)\n\n\n\n\nShow the code\nr_2016 <- read_csv2(\"/home/marc/Documents/postgrau UB/Sessio_4/data/rfd_barcelona_2016.csv\")\n\n\nr_0815 <- read_csv2(\"/home/marc/Documents/postgrau UB/Sessio_4/data/rfd_08_15.csv\",\n                    locale = locale(encoding = \"ISO-8859-1\"))\n\nr_0815 <- r_0815 |> \n  mutate(num.barri = as.numeric(str_extract(barri, \"\\\\d+\"))) |> \n  select(-barri)\n\nr <- left_join(r_2016, r_0815, by = \"num.barri\")\n\ngroups <- r |> \n  select(-num.barri, -Poblacio.16) |> \n  pivot_longer(cols = -c(nom.barri, districte), values_to = \"renda\", names_to = \"any\") |> \n  mutate(any = as.numeric(paste0(\"20\", str_remove(any, regex(\"rfd\\\\.\", ignore_case =TRUE))))) |>\n  group_by(districte, any) |> \n  summarise(\"renda\" = round(mean(renda, na.rm = TRUE),2)) |> \n  ungroup() |> \n  mutate(districte = case_when(districte == 1 ~ \"Ciutat Vella\",\n                               districte == 2 ~ \"Eixample\",\n                               districte == 3 ~ \"Sants-Montjuic\",\n                               districte == 4 ~ \"Les Corts\",\n                               districte == 5 ~ \"Sarrià-Sant Gervasi\",\n                               districte == 6 ~ \"Gràcia\",\n                               districte == 7 ~ \"Horta-Guinardó\",\n                               districte == 8 ~ \"Nou Barris\",\n                               districte == 9 ~ \"Sant Andreu\",\n                               TRUE ~ \"Sant Martí\"))\nknitr::kable(head(groups), style = \"pipe\")\n\n\n\n\n\ndistricte\nany\nrenda\n\n\n\n\nCiutat Vella\n2008\n72.78\n\n\nCiutat Vella\n2009\n77.38\n\n\nCiutat Vella\n2010\n79.53\n\n\nCiutat Vella\n2011\n80.75\n\n\nCiutat Vella\n2012\n80.85\n\n\nCiutat Vella\n2013\n84.30\n\n\n\n\n\nLa visualització que he triat és el que s’anomena un Sparkplot. Una visualització molt utilitzada pel politòleg Edward Tufte, que consisteix a fer una sèrie de gràfics de línies per les diferents unitats estudiades (en aquest cas, districtes) on es veu l’evolució de la variable que ens interessa (Índex de Renda Familiar). Per cada línia s’indica el rang entre el primer i el tercer quartil amb una àrea grisa i es marquen amb punts i etiquetes el primer valor, l’últim, el màxim i el mínim. Això ens permet eliminar el text de l’eix de les y i les línies auxiliars que fem servir normalment per a ubicar els valors de cada punt. Així, el gràfic queda més net i hi ha menys “soroll de fons”.\nLa metodologia per fer aquest gràfic està treta d’aquí.\n\n\nShow the code\nbeg <- group_by(groups, districte) |> filter(any == min(any))\nmins <- group_by(groups, districte) |> slice(which.min(renda))\nmaxs <- group_by(groups, districte) |> slice(which.max(renda))\nends <- group_by(groups, districte) |> filter(any == max(any))\nquarts <- groups |> \n  group_by(districte) |>\n  summarize(quart1 = quantile(renda, 0.25),\n            quart2 = quantile(renda, 0.75)) |>\n  right_join(groups)\n\nggplot(groups, aes(x = any, y = renda)) +\n  geom_ribbon(data = quarts, aes(ymin = quart1, max = quart2), fill = 'grey90') + # rang quartils\n  geom_line() +\n  geom_point(data = ends) + \n  geom_point(data = beg) + \n  geom_point(data = mins, col = \"red\") +\n  geom_point(data = maxs, col = \"blue\") + \n  geom_text(data = mins, aes(label = renda), vjust = -1,size = 5) +\n  geom_text(data = maxs, aes(label = renda), vjust = 2.5, size = 5) +\n  geom_text(data = ends, aes(label = renda), nudge_x = 1, size = 5) +\n  geom_text(data = beg, aes(label = renda), nudge_x = -1, size = 5) +\n  scale_x_continuous(breaks = seq(2008, 2016, 2)) +\n  scale_y_continuous(expand = c(0.2, 0)) + \n  theme_tufte(base_family = \"Montserrat\", base_size = 16) +\n  theme(axis.title=element_blank(), \n        axis.text.y = element_blank(), \n        axis.ticks = element_blank(), \n        strip.text.y = element_text(angle = 0, size = 16), # això fa que les etiquetes surtin en horitzontal - important\n        text = element_text(family = \"Montserrat\")) +\n  facet_grid(districte ~ ., scales = \"free_y\")\n\n\n\n\n\nEvolució de l’índex de renda familiar per districtes. Ajuntament de Barcelona.\n\n\n\n\nEl problema, com veieu al codi, és que vol moltes línies de codi: una per cada punt i una per cada etiqueta. Per tant, val la pena intentar-ho simplificar. La llibreria ggplot2 funciona amb un sistema una mica complicat d’objectes anomenats ggproto que es fan servir per crear funcions que dibuixin els gràfics. Per tant, ara en crearem un que assenyali l’inici, el final, el màxim i el mínim per cada districte amb punts.\n\n\nShow the code\nSparkPoints <- ggproto(\"SparkPoints\", Stat, \n                       required_aes = c(\"x\", \"y\", \"group\"),\n                       compute_group = function(data, scales){\n                       min <- data |> \n                         group_by(group) |> \n                         slice(which.min(y)) |> \n                         mutate(colour = \"red\")\n                       max <- data |> \n                         group_by(group) |> \n                         slice(which.max(y)) |> \n                         mutate(colour = \"blue\")\n                       start <- data |> \n                         group_by(group) |> \n                         filter(x == min(x)) |> \n                         mutate(colour = \"black\")\n                       finish <- data |> \n                         group_by(group) |> \n                         filter(x == max(x)) |> \n                         mutate(colour = \"black\")\n                       grid <- bind_rows(start, min, max, finish)\n                       grid\n                       }\n                       )\n\nstat_sparkpoints <- function(mapping = NULL, data = NULL, geom = \"point\",\n                             position = \"identity\", show.legend = TRUE,\n                             inherit.aes = TRUE){\n  layer(stat = SparkPoints, data = data, mapping = mapping, geom = geom, \n        position = position, show.legend = show.legend, inherit.aes = inherit.aes)\n}\n\n\n\n\nShow the code\nggplot(groups, aes(x = any, y = renda)) +\n  geom_ribbon(data = quarts, aes(ymin = quart1, max = quart2), fill = 'grey90') + # rang quartils\n  geom_line() +\n  stat_sparkpoints(aes(group = districte)) + \n  scale_x_continuous(breaks = seq(2008, 2016, 2)) +\n  scale_y_continuous(expand = c(0.2, 0)) + \n  theme_minimal(base_family = \"Montserrat\", base_size = 16) +\n  theme(axis.title=element_blank(), \n        strip.text.y = element_text(angle = 0, size = 16), # això fa que les etiquetes surtin en horitzontal - important\n        text = element_text(family = \"Montserrat\")) +\n  facet_grid(districte ~ ., scales = \"free_y\")\n\n\n\n\n\nEvolució de l’Índex de renda per districtes. Ajuntament de Barcelona. Punts obtinguts amb l’objecte SparkPoints.\n\n\n\n\nProblema, no ens surten les etiquetes i ens obliga a posar números a l’eix de les y, que fa el gràfic atapeït i de mal llegir. Això ho podem resoldre (més o menys, posant línies horitzontals i verticals que ens permetin ubicar els valors dins l’eix de coordenades), però també fa que el gràfic quedi atapeït, i trenquem els principis de Tufte. Una possible solució és posar només etiquetes al lloc dels punts, amb l’avantatge que un mateix objecte ens permet dibuixar o bé punts o bé etiquetes canviant el paràmetre geom quan dibuixem el gràfic. Vegem-ho.\n\n\nShow the code\nSparkLabels <- ggproto(\"SparkLabels\", Stat, \n                       required_aes = c(\"x\", \"y\", \"group\"),\n                       compute_group = function(data, scales){\n                       min <- data |> \n                         group_by(group) |> \n                         slice(which.min(y)) |> \n                         mutate(label = y,\n                                colour = \"red\")\n                       max <- data |> \n                         group_by(group) |> \n                         slice(which.max(y)) |> \n                         mutate(label = y,\n                                colour = \"blue\")\n                       start <- data |> \n                         group_by(group) |> \n                         filter(x == min(x)) |> \n                         mutate(label = y,\n                                colour = \"black\")\n                       finish <- data |> \n                         group_by(group) |> \n                         filter(x == max(x)) |> \n                         mutate(label = y,\n                                colour = \"black\")\n                       grid <- bind_rows(start, min, max, finish)\n                       grid\n                       }\n                       )\n\nstat_sparklabels <- function(mapping = NULL, data = NULL, geom = \"label\",\n                             position = \"identity\", show.legend = TRUE,\n                             inherit.aes = TRUE){\n  layer(stat = SparkLabels, data = data, mapping = mapping, geom = geom, \n        position = position, show.legend = show.legend, inherit.aes = inherit.aes)\n}\n\n\n\n\nShow the code\nggplot(groups, aes(x = any, y = renda)) +\n  geom_ribbon(data = quarts, aes(ymin = quart1, max = quart2), fill = 'grey90') + # rang quartils\n  geom_line() +\n  stat_sparklabels(aes(group = districte)) + \n  scale_x_continuous(breaks = seq(2008, 2016, 2)) +\n  scale_y_continuous(expand = c(0.2, 0)) + \n  theme_tufte(base_family = \"Montserrat\", base_size = 16) +\n  theme(axis.title=element_blank(), \n        axis.text.y = element_blank(), \n        axis.ticks = element_blank(),\n        strip.text.y = element_text(angle = 0, size = 16), # això fa que les etiquetes surtin en horitzontal - important\n        text = element_text(family = \"Montserrat\")) +\n  facet_grid(districte ~ ., scales = \"free_y\")\n\n\n\n\n\nEvolució de l’Índex de renda per districtes. Ajuntament de Barcelona. Etiquetes obtingudes amb l’objecte SparkLabels\n\n\n\n\n\n\nShow the code\nggplot(groups, aes(x = any, y = renda)) +\n  geom_ribbon(data = quarts, aes(ymin = quart1, max = quart2), fill = 'grey90') + # rang quartils\n  geom_line() +\n  stat_sparklabels(aes(group = districte), geom = \"point\") + \n  scale_x_continuous(breaks = seq(2008, 2016, 2)) +\n  scale_y_continuous(expand = c(0.2, 0)) + \n  theme_minimal(base_family = \"Montserrat\", base_size = 16) +\n  theme(axis.title=element_blank(), \n        strip.text.y = element_text(angle = 0, size = 16), # això fa que les etiquetes surtin en horitzontal - important\n        text = element_text(family = \"Montserrat\")) +\n  facet_grid(districte ~ ., scales = \"free_y\")\n\n\n\n\n\nEvolució de l’Índex de renda per districtes. Ajuntament de Barcelona. Punts obtinguts amb l’objecte SparkLabels utilitzant el paràmetre geom = 'point'"
  }
]